<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)">
<meta name="generator" content="Hexo 5.4.0">

<link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon/safari-pinned-tab.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ni9ne.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.8.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="数据库模型与 Eloquent复用或克隆query通常，我们需要从过滤后的查询中进行更多次查询。因此，大多数时候我们使用 query() 方法，让我们编写一个查询来获取今天创建的可用和不可用的产品">
<meta property="og:type" content="article">
<meta property="og:title" content="Laravel最佳实践-模型与Eloquent">
<meta property="og:url" content="https://ni9ne.github.io/2022/11/22/%E6%A1%86%E6%9E%B6/Laravel/Laravel%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-%E6%A8%A1%E5%9E%8B%E4%B8%8EEloquent/index.html">
<meta property="og:site_name" content="NI9NE&#39;s Zone">
<meta property="og:description" content="数据库模型与 Eloquent复用或克隆query通常，我们需要从过滤后的查询中进行更多次查询。因此，大多数时候我们使用 query() 方法，让我们编写一个查询来获取今天创建的可用和不可用的产品">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-11-22T14:51:11.000Z">
<meta property="article:modified_time" content="2023-10-26T03:24:42.076Z">
<meta property="article:author" content="NI9NE">
<meta property="article:tag" content="框架开发">
<meta property="article:tag" content="Laravel">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://ni9ne.github.io/2022/11/22/%E6%A1%86%E6%9E%B6/Laravel/Laravel%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-%E6%A8%A1%E5%9E%8B%E4%B8%8EEloquent/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://ni9ne.github.io/2022/11/22/%E6%A1%86%E6%9E%B6/Laravel/Laravel%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-%E6%A8%A1%E5%9E%8B%E4%B8%8EEloquent/","path":"2022/11/22/框架/Laravel/Laravel最佳实践-模型与Eloquent/","title":"Laravel最佳实践-模型与Eloquent"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Laravel最佳实践-模型与Eloquent | NI9NE's Zone</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">NI9NE's Zone</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">54</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">7</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">112</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A8%A1%E5%9E%8B%E4%B8%8E-Eloquent"><span class="nav-number">1.</span> <span class="nav-text">数据库模型与 Eloquent</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E7%94%A8%E6%88%96%E5%85%8B%E9%9A%86query"><span class="nav-number">1.1.</span> <span class="nav-text">复用或克隆query</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Eloquent-where%E6%97%A5%E6%9C%9F%E6%96%B9%E6%B3%95"><span class="nav-number">1.2.</span> <span class="nav-text">Eloquent where日期方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A2%9E%E9%87%8F%E5%92%8C%E5%87%8F%E9%87%8F"><span class="nav-number">1.3.</span> <span class="nav-text">增量和减量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A6%81%E6%AD%A2-timestamp-%E5%88%97"><span class="nav-number">1.4.</span> <span class="nav-text">禁止 timestamp 列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%AF%E5%88%A0%E9%99%A4-%E5%A4%9A%E8%A1%8C%E6%81%A2%E5%A4%8D"><span class="nav-number">1.5.</span> <span class="nav-text">软删除-多行恢复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Model-all-columns"><span class="nav-number">1.6.</span> <span class="nav-text">Model all-columns</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#To-Fail-or-not-to-Fail"><span class="nav-number">1.7.</span> <span class="nav-text">To Fail or not to Fail</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%97%E5%90%8D%E4%BF%AE%E6%94%B9"><span class="nav-number">1.8.</span> <span class="nav-text">列名修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E7%BB%93%E6%9E%9C%E9%9B%86%E5%90%88"><span class="nav-number">1.9.</span> <span class="nav-text">过滤结果集合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4%E7%9A%84Timestamp-%E5%AD%97%E6%AE%B5"><span class="nav-number">1.10.</span> <span class="nav-text">修改默认的Timestamp 字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%89%E7%85%A7created-at%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F"><span class="nav-number">1.11.</span> <span class="nav-text">按照created_at快速排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BD%93%E5%88%9B%E5%BB%BA%E8%AE%B0%E5%BD%95%E6%97%B6%E8%87%AA%E5%8A%A8%E4%BF%AE%E6%94%B9%E6%9F%90%E4%BA%9B%E5%88%97%E7%9A%84%E5%80%BC"><span class="nav-number">1.12.</span> <span class="nav-text">当创建记录时自动修改某些列的值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%9F%E5%A7%8B%E6%9F%A5%E8%AF%A2%E8%AE%A1%E7%AE%97%E8%BF%90%E8%A1%8C%E5%BE%97%E6%9B%B4%E5%BF%AB"><span class="nav-number">1.13.</span> <span class="nav-text">数据库原始查询计算运行得更快</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E6%AD%A2%E4%B8%80%E4%B8%AA%E8%8C%83%E5%9B%B4"><span class="nav-number">1.14.</span> <span class="nav-text">不止一个范围</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A0%E9%9C%80%E8%BD%AC%E6%8D%A2-Carbon"><span class="nav-number">1.15.</span> <span class="nav-text">无需转换 Carbon</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE%E9%A6%96%E5%AD%97%E6%AF%8D%E5%88%86%E7%BB%84"><span class="nav-number">1.16.</span> <span class="nav-text">根据首字母分组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B0%B8%E4%B8%8D%E6%9B%B4%E6%96%B0%E6%9F%90%E4%B8%AA%E5%AD%97%E6%AE%B5"><span class="nav-number">1.17.</span> <span class="nav-text">永不更新某个字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#find-%E6%9F%A5%E8%AF%A2%E5%A4%9A%E6%9D%A1%E6%95%B0%E6%8D%AE"><span class="nav-number">1.18.</span> <span class="nav-text">find () 查询多条数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#find%E5%A4%9A%E4%B8%AA%E6%A8%A1%E5%9E%8B%E5%B9%B6%E8%BF%94%E5%9B%9E%E5%A4%9A%E5%88%97"><span class="nav-number">1.19.</span> <span class="nav-text">find多个模型并返回多列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%89%E7%85%A7%E9%94%AE%E6%9F%A5%E6%89%BE"><span class="nav-number">1.20.</span> <span class="nav-text">按照键查找</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8UUID%E6%9B%BF%E6%8D%A2auto-increment"><span class="nav-number">1.21.</span> <span class="nav-text">使用UUID替换auto-increment</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Laravel-%E4%B8%AD%E7%9A%84%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.22.</span> <span class="nav-text">Laravel 中的子查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9A%90%E8%97%8F%E6%9F%90%E4%BA%9B%E5%88%97"><span class="nav-number">1.23.</span> <span class="nav-text">隐藏某些列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A1%AE%E5%AE%9ADB%E6%8A%A5%E9%94%99"><span class="nav-number">1.24.</span> <span class="nav-text">确定DB报错</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%AF%E5%88%A0%E9%99%A4%E4%B8%8E%E6%9F%A5%E8%AF%A2%E6%9E%84%E9%80%A0%E5%99%A8"><span class="nav-number">1.25.</span> <span class="nav-text">软删除与查询构造器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL%E5%A3%B0%E6%98%8E"><span class="nav-number">1.26.</span> <span class="nav-text">SQL声明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1"><span class="nav-number">1.27.</span> <span class="nav-text">数据库事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E6%88%96%E5%88%9B%E5%BB%BA"><span class="nav-number">1.28.</span> <span class="nav-text">更新或创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%9D%E5%AD%98%E6%97%B6%E7%A7%BB%E9%99%A4%E7%BC%93%E5%AD%98"><span class="nav-number">1.29.</span> <span class="nav-text">保存时移除缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9Created-at%E5%92%8CUpdated-at%E7%9A%84%E6%A0%BC%E5%BC%8F"><span class="nav-number">1.30.</span> <span class="nav-text">修改Created_at和Updated_at的格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B%E5%AD%98%E5%82%A8%E5%88%B0-JSON-%E4%B8%AD"><span class="nav-number">1.31.</span> <span class="nav-text">数组类型存储到 JSON 中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E5%88%B6%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.32.</span> <span class="nav-text">复制一个模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%8D%E4%BD%8E%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8"><span class="nav-number">1.33.</span> <span class="nav-text">降低内存占用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BF%BD%E7%95%A5-fillable-guarded-%E5%B9%B6%E5%BC%BA%E5%88%B6%E6%89%A7%E8%A1%8C"><span class="nav-number">1.34.</span> <span class="nav-text">忽略 $fillable&#x2F;$guarded 并强制执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E5%B1%82%E7%88%B6%E5%AD%90%E7%BA%A7%E7%BB%93%E6%9E%84"><span class="nav-number">1.35.</span> <span class="nav-text">3层父子级结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-find-%E6%9D%A5%E6%90%9C%E7%B4%A2%E6%9B%B4%E5%A4%9A%E7%9A%84%E8%AE%B0%E5%BD%95"><span class="nav-number">1.36.</span> <span class="nav-text">使用 find() 来搜索更多的记录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%B1%E8%B4%A5%E6%97%B6%E6%89%A7%E8%A1%8C%E4%BB%BB%E4%BD%95%E6%93%8D%E4%BD%9C"><span class="nav-number">1.37.</span> <span class="nav-text">失败时执行任何操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5%E8%AE%B0%E5%BD%95%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E5%90%A6%E5%88%99%E6%98%BE%E7%A4%BA-404"><span class="nav-number">1.38.</span> <span class="nav-text">检查记录是否存在否则显示 404</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E8%AF%AD%E5%8F%A5%E4%B8%BA%E5%90%A6%E6%97%B6%E4%B8%AD%E6%AD%A2"><span class="nav-number">1.39.</span> <span class="nav-text">条件语句为否时中止</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E5%88%A0%E9%99%A4%E6%A8%A1%E5%9E%8B%E4%B9%8B%E5%89%8D%E6%89%A7%E8%A1%8C%E4%BB%BB%E4%BD%95%E9%A2%9D%E5%A4%96%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="nav-number">1.40.</span> <span class="nav-text">在删除模型之前执行任何额外的操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BD%93%E4%BD%A0%E9%9C%80%E8%A6%81%E5%9C%A8%E4%BF%9D%E5%AD%98%E6%95%B0%E6%8D%AE%E5%88%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E6%97%B6%E8%87%AA%E5%8A%A8%E5%A1%AB%E5%85%85%E4%B8%80%E4%B8%AA%E5%AD%97%E6%AE%B5"><span class="nav-number">1.41.</span> <span class="nav-text">当你需要在保存数据到数据库时自动填充一个字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E7%9A%84%E9%A2%9D%E5%A4%96%E4%BF%A1%E6%81%AF"><span class="nav-number">1.42.</span> <span class="nav-text">获取查询语句的额外信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8-Laravel-%E4%B8%AD%E4%BD%BF%E7%94%A8doesntExist-%E6%96%B9%E6%B3%95"><span class="nav-number">1.43.</span> <span class="nav-text">在 Laravel 中使用doesntExist()方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E4%B8%80%E4%BA%9B%E6%A8%A1%E5%9E%8B%E7%9A%84-boot-%E6%96%B9%E6%B3%95%E4%B8%AD%E8%87%AA%E5%8A%A8%E8%B0%83%E7%94%A8%E4%B8%80%E4%B8%AA%E7%89%B9%E6%80%A7"><span class="nav-number">1.44.</span> <span class="nav-text">在一些模型的 boot () 方法中自动调用一个特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Laravel-%E7%9A%84-find-%E6%96%B9%E6%B3%95%EF%BC%8C%E6%AF%94%E5%8F%AA%E4%BC%A0%E4%B8%80%E4%B8%AA-ID-%E6%9B%B4%E5%A4%9A%E7%9A%84%E9%80%89%E6%8B%A9"><span class="nav-number">1.45.</span> <span class="nav-text">Laravel 的 find () 方法，比只传一个 ID 更多的选择</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8-Laravel-%E4%B8%AD%E6%9C%89%E4%B8%A4%E7%A7%8D%E5%B8%B8%E8%A7%81%E7%9A%84%E6%96%B9%E6%B3%95%E6%9D%A5%E7%A1%AE%E5%AE%9A%E4%B8%80%E4%B8%AA%E8%A1%A8%E6%98%AF%E5%90%A6%E4%B8%BA%E7%A9%BA%E8%A1%A8"><span class="nav-number">1.46.</span> <span class="nav-text">在 Laravel 中有两种常见的方法来确定一个表是否为空表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D-property-of-non-object-%E9%94%99%E8%AF%AF"><span class="nav-number">1.47.</span> <span class="nav-text">如何避免 property of non-object 错误</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Eloquent-%E6%95%B0%E6%8D%AE%E6%94%B9%E5%8F%98%E5%90%8E%E8%8E%B7%E5%8F%96%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE"><span class="nav-number">1.48.</span> <span class="nav-text">Eloquent 数据改变后获取原始数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E7%A7%8D%E6%9B%B4%E7%AE%80%E5%8D%95%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">1.49.</span> <span class="nav-text">一种更简单创建数据库的方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Query%E6%9E%84%E9%80%A0%E5%99%A8%E7%9A%84crossJoinSub%E6%96%B9%E6%B3%95"><span class="nav-number">1.50.</span> <span class="nav-text">Query构造器的crossJoinSub方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#belongsToMany%E7%9A%84%E4%B8%AD%E9%97%B4%E8%A1%A8%E5%91%BD%E5%90%8D"><span class="nav-number">1.51.</span> <span class="nav-text">belongsToMany的中间表命名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AEPivot%E5%AD%97%E6%AE%B5%E6%8E%92%E5%BA%8F"><span class="nav-number">1.52.</span> <span class="nav-text">根据Pivot字段排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E6%9F%A5%E8%AF%A2%E4%B8%80%E6%9D%A1%E8%AE%B0%E5%BD%95"><span class="nav-number">1.53.</span> <span class="nav-text">从数据库中查询一条记录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%B0%E5%BD%95%E8%87%AA%E5%8A%A8%E5%88%86%E5%9D%97"><span class="nav-number">1.54.</span> <span class="nav-text">记录自动分块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E6%97%B6%E6%B8%85%E7%90%86%E8%BF%87%E6%9C%9F%E8%AE%B0%E5%BD%95%E4%B8%AD%E7%9A%84%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.55.</span> <span class="nav-text">定时清理过期记录中的模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E5%8F%98%E7%9A%84%E6%97%A5%E6%9C%9F%E5%92%8C%E5%AF%B9%E5%AE%83%E4%BB%AC%E7%9A%84%E5%BC%BA%E5%88%B6%E8%BD%AC%E6%8D%A2"><span class="nav-number">1.56.</span> <span class="nav-text">不变的日期和对它们的强制转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#findorfail%E6%96%B9%E6%B3%95%E4%B9%9F%E6%8E%A5%E6%94%B6ids%E6%95%B0%E7%BB%84"><span class="nav-number">1.57.</span> <span class="nav-text">findorfail方法也接收ids数组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E4%BD%A0%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E8%87%AA%E5%8A%A8%E7%A7%BB%E9%99%A4%E6%A8%A1%E5%9E%8BprunableTrait"><span class="nav-number">1.58.</span> <span class="nav-text">从你的数据库中自动移除模型prunableTrait</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E6%9C%9F%E8%BD%AC%E6%8D%A2"><span class="nav-number">1.59.</span> <span class="nav-text">日期转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E6%A8%A1%E5%9E%8B%E6%9B%B4%E6%96%B0%E6%8F%92%E5%85%A5"><span class="nav-number">1.60.</span> <span class="nav-text">多模型更新插入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E7%BB%93%E6%9E%9C%E9%9B%86%E4%B9%8B%E5%90%8E%E8%8E%B7%E5%8F%96%E6%9F%A5%E8%AF%A2%E6%9E%84%E9%80%A0%E5%99%A8"><span class="nav-number">1.61.</span> <span class="nav-text">过滤结果集之后获取查询构造器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E8%81%9A%E5%90%88%E8%AE%A1%E7%AE%97%E7%9B%B8%E5%85%B3%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.62.</span> <span class="nav-text">选择聚合计算相关模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%BA%E5%88%B6%E8%BD%AC%E6%8D%A2"><span class="nav-number">1.63.</span> <span class="nav-text">自定义强制转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%9D%E5%AD%98%E4%B8%AD%E4%B8%8D%E8%A6%81%E8%A7%A6%E5%8F%91%E4%BA%8B%E4%BB%B6"><span class="nav-number">1.64.</span> <span class="nav-text">保存中不要触发事件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E7%9B%B8%E5%85%B3%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%B9%B3%E5%9D%87%E5%80%BC%E6%88%96%E6%80%BB%E6%95%B0%E6%8E%92%E5%BA%8F"><span class="nav-number">1.65.</span> <span class="nav-text">基于相关模型的平均值或总数排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E4%BA%8B%E5%8A%A1%E7%BB%93%E6%9E%9C"><span class="nav-number">1.66.</span> <span class="nav-text">返回事务结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8Equery%E4%B8%AD%E7%A7%BB%E9%99%A4%E5%A4%9A%E4%B8%AA%E5%85%AC%E5%85%B1scope"><span class="nav-number">1.67.</span> <span class="nav-text">从query中移除多个公共scope</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JSON%E5%88%97%E5%B1%9E%E6%80%A7%E6%8E%92%E5%BA%8F"><span class="nav-number">1.68.</span> <span class="nav-text">JSON列属性排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E7%AC%AC%E4%B8%80%E4%B8%AA%E7%BB%93%E6%9E%9C%E4%B8%AD%E8%8E%B7%E5%8F%96%E5%8D%95%E5%88%97%E7%9A%84%E5%80%BC"><span class="nav-number">1.69.</span> <span class="nav-text">从第一个结果中获取单列的值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A3%80%E6%B5%8B%E6%A8%A1%E5%9E%8B%E5%B1%9E%E6%80%A7%E6%98%AF%E5%90%A6%E8%A2%AB%E4%BF%AE%E6%94%B9"><span class="nav-number">1.70.</span> <span class="nav-text">检测模型属性是否被修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E8%AE%BF%E9%97%AE%E5%99%A8%E4%B8%8E%E4%BF%AE%E6%94%B9%E5%99%A8%E7%9A%84%E6%96%B0%E6%96%B9%E6%B3%95"><span class="nav-number">1.71.</span> <span class="nav-text">定义访问器与修改器的新方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%A6%E5%A4%96%E4%B8%80%E7%A7%8D%E5%AE%9A%E4%B9%89%E8%AE%BF%E9%97%AE%E5%99%A8%E4%B8%8E%E4%BF%AE%E6%94%B9%E5%99%A8%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">1.72.</span> <span class="nav-text">另外一种定义访问器与修改器的方法</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="NI9NE"
      src="/images/favicon/mstile-150x150.png">
  <p class="site-author-name" itemprop="name">NI9NE</p>
  <div class="site-description" itemprop="description">TECH OTAKU SAVE THE WORLD</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">112</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">54</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ni9ne" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ni9ne" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://gitee.com/ni9ne" title="Gitee → https:&#x2F;&#x2F;gitee.com&#x2F;ni9ne" rel="noopener" target="_blank"><i class="fab fa-git fa-fw"></i>Gitee</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://unpkg.com/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://gitee.com/ni9ne" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ni9ne.github.io/2022/11/22/%E6%A1%86%E6%9E%B6/Laravel/Laravel%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-%E6%A8%A1%E5%9E%8B%E4%B8%8EEloquent/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon/mstile-150x150.png">
      <meta itemprop="name" content="NI9NE">
      <meta itemprop="description" content="TECH OTAKU SAVE THE WORLD">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NI9NE's Zone">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Laravel最佳实践-模型与Eloquent
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-11-22 22:51:11" itemprop="dateCreated datePublished" datetime="2022-11-22T22:51:11+08:00">2022-11-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91%E8%B5%84%E6%96%99/" itemprop="url" rel="index"><span itemprop="name">开发资料</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="数据库模型与-Eloquent"><a href="#数据库模型与-Eloquent" class="headerlink" title="数据库模型与 Eloquent"></a>数据库模型与 Eloquent</h2><h3 id="复用或克隆query"><a href="#复用或克隆query" class="headerlink" title="复用或克隆query"></a>复用或克隆query</h3><p>通常，我们需要从过滤后的查询中进行更多次查询。因此，大多数时候我们使用 query() 方法，<br>让我们编写一个查询来获取今天创建的可用和不可用的产品</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$query</span> = Product::query();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$today</span> = request()-&gt;q_date ?? today();</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$today</span>)&#123;</span><br><span class="line">    <span class="variable">$query</span>-&gt;where(<span class="string">&#x27;created_at&#x27;</span>, <span class="variable">$today</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 让我们获取可用和不可用的产品</span></span><br><span class="line"><span class="variable">$active_products</span> = <span class="variable">$query</span>-&gt;where(<span class="string">&#x27;status&#x27;</span>, <span class="number">1</span>)-&gt;get(); <span class="comment">// 这一行 修改了$query 对象变量</span></span><br><span class="line"><span class="variable">$inactive_products</span> = <span class="variable">$query</span>-&gt;where(<span class="string">&#x27;status&#x27;</span>, <span class="number">0</span>)-&gt;get(); <span class="comment">// 所以这里我们将获取不到任何不可用产品</span></span><br></pre></td></tr></table></figure>

<p>但是，在获得 <code>$active products</code> 后，<code>$query</code> 会被修改。因此 <code>$inactive_products</code> 不会从 <code>$query</code> 中获取到不可用产品，并且每次都返回空集合。因为，它尝试从 <code>$active_products</code> 中查找不可用产品（<code>$query</code> 仅返回可用产品）。</p>
<p>为了解决这个问题,我们可以通过重用这个<code>$query</code>对象来查询多次。因此我们在做任何对<code>$query</code>修改操作的时候需要克隆这个<code>$query</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$active_products</span> = (<span class="keyword">clone</span> <span class="variable">$query</span>)-&gt;where(<span class="string">&#x27;status&#x27;</span>, <span class="number">1</span>)-&gt;get(); <span class="comment">// it will not modify the $query</span></span><br><span class="line"><span class="variable">$inactive_products</span> = (<span class="keyword">clone</span> <span class="variable">$query</span>)-&gt;where(<span class="string">&#x27;status&#x27;</span>, <span class="number">0</span>)-&gt;get(); <span class="comment">// so we will get inactive products from $query</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Eloquent-where日期方法"><a href="#Eloquent-where日期方法" class="headerlink" title="Eloquent where日期方法"></a>Eloquent where日期方法</h3><p>在 Eloquent 中，使用 <code>whereDay()</code>、<code>whereMonth()</code>、<code>whereYear()</code>、<code>whereDate()</code> 和 <code>whereTime()</code> 函数检查日期。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$products</span> = Product::whereDate(<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;2018-01-31&#x27;</span>)-&gt;get();</span><br><span class="line"><span class="variable">$products</span> = Product::whereMonth(<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;12&#x27;</span>)-&gt;get();</span><br><span class="line"><span class="variable">$products</span> = Product::whereDay(<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;31&#x27;</span>)-&gt;get();</span><br><span class="line"><span class="variable">$products</span> = Product::whereYear(<span class="string">&#x27;created_at&#x27;</span>, date(<span class="string">&#x27;Y&#x27;</span>))-&gt;get();</span><br><span class="line"><span class="variable">$products</span> = Product::whereTime(<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;14:13:58&#x27;</span>)-&gt;get();</span><br></pre></td></tr></table></figure>

<h3 id="增量和减量"><a href="#增量和减量" class="headerlink" title="增量和减量"></a>增量和减量</h3><p>如果要增加数据库某个表中的某个列的值，只需要使用 <code>increment()</code> 函数。你不仅可以增加 1，还可以增加其他数字，如 50。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Post::find(<span class="variable">$post_id</span>)-&gt;increment(<span class="string">&#x27;view_count&#x27;</span>);</span><br><span class="line">User::find(<span class="variable">$user_id</span>)-&gt;increment(<span class="string">&#x27;points&#x27;</span>, <span class="number">50</span>);</span><br></pre></td></tr></table></figure>

<h3 id="禁止-timestamp-列"><a href="#禁止-timestamp-列" class="headerlink" title="禁止 timestamp 列"></a>禁止 timestamp 列</h3><p>如果你的数据库表不包含 timestamp 字段 <code>created_at</code> 和 <code>updated_at</code>，你可以使用 <code>$timestamps = false</code> 属性指定 Eloquent 模型不使用它们。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Company</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$timestamps</span> = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="软删除-多行恢复"><a href="#软删除-多行恢复" class="headerlink" title="软删除-多行恢复"></a>软删除-多行恢复</h3><p>使用软删除时，可以在一个句子中恢复多行。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Post::onlyTrashed()-&gt;where(<span class="string">&#x27;author_id&#x27;</span>, <span class="number">1</span>)-&gt;restore();</span><br></pre></td></tr></table></figure>

<h3 id="Model-all-columns"><a href="#Model-all-columns" class="headerlink" title="Model all-columns"></a>Model all-columns</h3><p>当调用Eloquent’s <code>Model::all()</code>时你可以指定返回哪些列。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = User::all([<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;email&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<h3 id="To-Fail-or-not-to-Fail"><a href="#To-Fail-or-not-to-Fail" class="headerlink" title="To Fail or not to Fail"></a>To Fail or not to Fail</h3><p>除了 <code>findOrFail()</code> 之外，还有 Eloquent 方法 <code>firstOrFail()</code>，如果没有找到查询记录，它将返回 <code>404</code> 页面。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = User::where(<span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;povilas@laraveldaily.com&#x27;</span>)-&gt;firstOrFail();</span><br></pre></td></tr></table></figure>

<h3 id="列名修改"><a href="#列名修改" class="headerlink" title="列名修改"></a>列名修改</h3><p>在 <code>Eloquent Query Builder</code> 中，您可以像在普通 SQL 查询中一样指定<code>as</code>以返回任何列的别名。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::table(<span class="string">&#x27;users&#x27;</span>)-&gt;select(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;email as user_email&#x27;</span>)-&gt;get();</span><br></pre></td></tr></table></figure>

<h3 id="过滤结果集合"><a href="#过滤结果集合" class="headerlink" title="过滤结果集合"></a>过滤结果集合</h3><p>在 <code>Eloquent</code> 查询到结果之后，您可以使用 Collections 中的 <code>map()</code> 函数来修改行数据。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = User::where(<span class="string">&#x27;role_id&#x27;</span>, <span class="number">1</span>)-&gt;get()-&gt;map(<span class="function"><span class="keyword">function</span> (<span class="params">User <span class="variable">$user</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$user</span>-&gt;some_column = some_function(<span class="variable">$user</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$user</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="修改默认的Timestamp-字段"><a href="#修改默认的Timestamp-字段" class="headerlink" title="修改默认的Timestamp 字段"></a>修改默认的Timestamp 字段</h3><p>如果您使用的是非 <code>Laravel</code> 数据库并且时间戳列的名称不同怎么办？也许，你有 <code>create_time</code> 和 <code>update_time</code>。 幸运的是，您也可以在模型中指定它们：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> CREATED_AT = <span class="string">&#x27;create_time&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> UPDATED_AT = <span class="string">&#x27;update_time&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="按照created-at快速排序"><a href="#按照created-at快速排序" class="headerlink" title="按照created_at快速排序"></a>按照created_at快速排序</h3><p>不用:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User::orderBy(<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;desc&#x27;</span>)-&gt;get();</span><br></pre></td></tr></table></figure>

<p>你可以更快的使用排序:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User::latest()-&gt;get();</span><br></pre></td></tr></table></figure>

<p>默认情况下 <code>latest()</code> 将按照 <code>created_at</code>排序。</p>
<p>有一个相反的方法 <code>oldest()</code>，按 created_at 升序排序：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User::oldest()-&gt;get();</span><br></pre></td></tr></table></figure>

<p>您也可以指定另一列进行排序。 例如，如果你想使用 <code>updated_at</code>，你可以这样做：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$lastUpdatedUser</span> = User::latest(<span class="string">&#x27;updated_at&#x27;</span>)-&gt;first();</span><br></pre></td></tr></table></figure>

<h3 id="当创建记录时自动修改某些列的值"><a href="#当创建记录时自动修改某些列的值" class="headerlink" title="当创建记录时自动修改某些列的值"></a>当创建记录时自动修改某些列的值</h3><p>如果您想在创建记录时生成一些 DB 列值，请将其添加到模型的 boot() 方法中。<br>例如，如果您有一个字段 「position」，并且想要赋值下一个可用位置（如 Country::max(‘position’) + 1)，请执行以下操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Country</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::boot();</span><br><span class="line"></span><br><span class="line">        Country::creating(<span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$model</span></span>) </span>&#123;</span><br><span class="line">            <span class="variable">$model</span>-&gt;position = Country::max(<span class="string">&#x27;position&#x27;</span>) + <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数据库原始查询计算运行得更快"><a href="#数据库原始查询计算运行得更快" class="headerlink" title="数据库原始查询计算运行得更快"></a>数据库原始查询计算运行得更快</h3><p>使用类似 <code>whereRaw()</code> 方法的 SQL 原始查询，直接在查询中进行一些数据库特定计算，而不是在 Laravel 中，通常情况下结果会更快。 例如，如果您想获得注册后 30 天以上仍处于活跃状态的用户，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User::where(<span class="string">&#x27;active&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">    -&gt;whereRaw(<span class="string">&#x27;TIMESTAMPDIFF(DAY, created_at, updated_at) &gt; ?&#x27;</span>, <span class="number">30</span>)</span><br><span class="line">    -&gt;get();</span><br></pre></td></tr></table></figure>

<h3 id="不止一个范围"><a href="#不止一个范围" class="headerlink" title="不止一个范围"></a>不止一个范围</h3><p>您可以在 Eloquent 中组合和链式调用查询范围，在一个<code>query</code>查询中使用多个范围。</p>
<p>Model文件内:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">scopeActive</span>(<span class="params"><span class="variable">$query</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$query</span>-&gt;where(<span class="string">&#x27;active&#x27;</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">scopeRegisteredWithinDays</span>(<span class="params"><span class="variable">$query</span>, <span class="variable">$days</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$query</span>-&gt;where(<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;&gt;=&#x27;</span>, now()-&gt;subDays(<span class="variable">$days</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控制器内:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = User::registeredWithinDays(<span class="number">30</span>)-&gt;active()-&gt;get();</span><br></pre></td></tr></table></figure>

<h3 id="无需转换-Carbon"><a href="#无需转换-Carbon" class="headerlink" title="无需转换 Carbon"></a>无需转换 Carbon</h3><p>如果你正使用 <code>whereDate()</code> 查询今日的记录，可以直接使用 <code>Carbon</code> 的 <code>now()</code> 方法，它会自动转换为日期进行查询，而不需要指定 -&gt;toDateString()。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不用</span></span><br><span class="line"><span class="variable">$todayUsers</span> = User::whereDate(<span class="string">&#x27;created_at&#x27;</span>, now()-&gt;toDateString())-&gt;get();</span><br><span class="line"><span class="comment">// 不用做转换 只需要用 now()</span></span><br><span class="line"><span class="variable">$todayUsers</span> = User::whereDate(<span class="string">&#x27;created_at&#x27;</span>, now())-&gt;get();</span><br></pre></td></tr></table></figure>

<h3 id="根据首字母分组"><a href="#根据首字母分组" class="headerlink" title="根据首字母分组"></a>根据首字母分组</h3><p>你可以用任意自定义条件对 Eloquent 结果进行分组，下面的示例是由用户名的第一个单词进行分组:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = User::all()-&gt;groupBy(<span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$item</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$item</span>-&gt;name[<span class="number">0</span>];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="永不更新某个字段"><a href="#永不更新某个字段" class="headerlink" title="永不更新某个字段"></a>永不更新某个字段</h3><p>如果有一个数据库字段你想只设置一次并不想再次更新，您可以在Eloquent的模型上使用一个修改器设置该限制：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setEmailAttribute</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;email) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;attributes[<span class="string">&#x27;email&#x27;</span>] = <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="find-查询多条数据"><a href="#find-查询多条数据" class="headerlink" title="find () 查询多条数据"></a>find () 查询多条数据</h3><p><code>find()</code>方法可以接受多参数, 传入多个值时会返回所有找到记录的集合，而不是一个模型:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回 Eloquent Model</span></span><br><span class="line"><span class="variable">$user</span> = User::find(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 返回 Eloquent Collection</span></span><br><span class="line"><span class="variable">$users</span> = User::find([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]);</span><br></pre></td></tr></table></figure>

<p>技巧来自 <a target="_blank" rel="noopener" href="https://twitter.com/tahiriqbalnajam/status/1436120403655671817">@tahiriqbalnajam</a></p>
<h3 id="find多个模型并返回多列"><a href="#find多个模型并返回多列" class="headerlink" title="find多个模型并返回多列"></a>find多个模型并返回多列</h3><p><code>find</code>方法可接受多参数 使得结果集返回指定列的模型集合，而不是模型的所有列:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Will return Eloquent Model with first_name and email only</span></span><br><span class="line"><span class="variable">$user</span> = User::find(<span class="number">1</span>, [<span class="string">&#x27;first_name&#x27;</span>, <span class="string">&#x27;email&#x27;</span>]);</span><br><span class="line"><span class="comment">// Will return Eloquent Collection with first_name and email only</span></span><br><span class="line"><span class="variable">$users</span> = User::find([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>], [<span class="string">&#x27;first_name&#x27;</span>, <span class="string">&#x27;email&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>技巧来自 <a target="_blank" rel="noopener" href="https://github.com/tahiriqbalnajam">@tahiriqbalnajam</a></p>
<h3 id="按照键查找"><a href="#按照键查找" class="headerlink" title="按照键查找"></a>按照键查找</h3><p>您还可以使用<code>whereKey()</code>方法根据您指定的主键查找多条记录。(默认<code>id</code>但是你可以在Eloquent 模型中覆盖掉)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = User::whereKey([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>])-&gt;get();</span><br></pre></td></tr></table></figure>

<h3 id="使用UUID替换auto-increment"><a href="#使用UUID替换auto-increment" class="headerlink" title="使用UUID替换auto-increment"></a>使用UUID替换auto-increment</h3><p>您不想在模型中使用自动递增 ID？</p>
<p>迁移:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Schema::create(<span class="string">&#x27;users&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">Blueprint <span class="variable">$table</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// $table-&gt;increments(&#x27;id&#x27;);</span></span><br><span class="line">    <span class="variable">$table</span>-&gt;uuid(<span class="string">&#x27;id&#x27;</span>)-&gt;unique();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>模型:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$incrementing</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$keyType</span> = <span class="string">&#x27;string&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::boot();</span><br><span class="line"></span><br><span class="line">        User::creating(<span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$model</span></span>) </span>&#123;</span><br><span class="line">            <span class="variable">$model</span>-&gt;setId();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setId</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;attributes[<span class="string">&#x27;id&#x27;</span>] = Str::uuid();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Laravel-中的子查询"><a href="#Laravel-中的子查询" class="headerlink" title="Laravel 中的子查询"></a>Laravel 中的子查询</h3><p>从 Laravel 6 开始，您可以在 Eloquent 语句中使用 <code>addSelect()</code>方法，对列进行一些计算。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> Destination::addSelect([<span class="string">&#x27;last_flight&#x27;</span> =&gt; Flight::select(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    -&gt;whereColumn(<span class="string">&#x27;destination_id&#x27;</span>, <span class="string">&#x27;destinations.id&#x27;</span>)</span><br><span class="line">    -&gt;orderBy(<span class="string">&#x27;arrived_at&#x27;</span>, <span class="string">&#x27;desc&#x27;</span>)</span><br><span class="line">    -&gt;limit(<span class="number">1</span>)</span><br><span class="line">])-&gt;get();</span><br></pre></td></tr></table></figure>

<h3 id="隐藏某些列"><a href="#隐藏某些列" class="headerlink" title="隐藏某些列"></a>隐藏某些列</h3><p>在进行 Eloquent 查询时，如果您想在返回中隐藏特定字段，最快捷的方法之一是在集合结果上添加 <code>-&gt;makeHidden()</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = User::all()-&gt;makeHidden([<span class="string">&#x27;email_verified_at&#x27;</span>, <span class="string">&#x27;deleted_at&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<h3 id="确定DB报错"><a href="#确定DB报错" class="headerlink" title="确定DB报错"></a>确定DB报错</h3><p>如果您想捕获 Eloquent Query 异常，请使用特定的 <code>QueryException</code> 代替默认的 <code>Exception</code> 类，您将能够获得SQL确切的错误代码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// Some Eloquent/SQL statement</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (\Illuminate\Database\QueryException <span class="variable">$e</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$e</span>-&gt;getCode() === <span class="string">&#x27;23000&#x27;</span>) &#123; <span class="comment">// integrity constraint violation</span></span><br><span class="line">        <span class="keyword">return</span> back()-&gt;withError(<span class="string">&#x27;Invalid data&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="软删除与查询构造器"><a href="#软删除与查询构造器" class="headerlink" title="软删除与查询构造器"></a>软删除与查询构造器</h3><p>注意 当你用到 <code>Eloquent</code>时 软删除将会起作用，但是查询构造器不行。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将排除软删除的条目</span></span><br><span class="line"><span class="variable">$users</span> = User::all();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将不会排除软删除的条目</span></span><br><span class="line"><span class="variable">$users</span> = User::withTrashed()-&gt;get();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将不会排除软删除的条目</span></span><br><span class="line"><span class="variable">$users</span> = DB::table(<span class="string">&#x27;users&#x27;</span>)-&gt;get();</span><br></pre></td></tr></table></figure>

<h3 id="SQL声明"><a href="#SQL声明" class="headerlink" title="SQL声明"></a>SQL声明</h3><p>如果你需要执行一个简单的 SQL 查询，但没有方案 —— 比如改变数据库模式中的某些东西，只需执行 DB::statement()。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DB::statement(<span class="string">&#x27;DROP TABLE users&#x27;</span>);</span><br><span class="line">DB::statement(<span class="string">&#x27;ALTER TABLE projects AUTO_INCREMENT=123&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="数据库事务"><a href="#数据库事务" class="headerlink" title="数据库事务"></a>数据库事务</h3><p>如果您执行了两个数据库操作，第二个可能会出错，那么您应该回滚第一个，对吗？<br>为此，我建议使用 DB Transactions，它在 Laravel 中非常简单：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DB::transaction(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    DB::table(<span class="string">&#x27;users&#x27;</span>)-&gt;update([<span class="string">&#x27;votes&#x27;</span> =&gt; <span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    DB::table(<span class="string">&#x27;posts&#x27;</span>)-&gt;delete();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="更新或创建"><a href="#更新或创建" class="headerlink" title="更新或创建"></a>更新或创建</h3><p>如果你需要检查记录是否存在，然后更新它，或者创建一个新记录，你可以用一句话来完成 - 使用 Eloquent updateOrCreate() 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Instead of this</span></span><br><span class="line"><span class="variable">$flight</span> = Flight::where(<span class="string">&#x27;departure&#x27;</span>, <span class="string">&#x27;Oakland&#x27;</span>)</span><br><span class="line">    -&gt;where(<span class="string">&#x27;destination&#x27;</span>, <span class="string">&#x27;San Diego&#x27;</span>)</span><br><span class="line">    -&gt;first();</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$flight</span>) &#123;</span><br><span class="line">    <span class="variable">$flight</span>-&gt;update([<span class="string">&#x27;price&#x27;</span> =&gt; <span class="number">99</span>, <span class="string">&#x27;discounted&#x27;</span> =&gt; <span class="number">1</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="variable">$flight</span> = Flight::create([</span><br><span class="line">	    <span class="string">&#x27;departure&#x27;</span> =&gt; <span class="string">&#x27;Oakland&#x27;</span>,</span><br><span class="line">	    <span class="string">&#x27;destination&#x27;</span> =&gt; <span class="string">&#x27;San Diego&#x27;</span>,</span><br><span class="line">	    <span class="string">&#x27;price&#x27;</span> =&gt; <span class="number">99</span>,</span><br><span class="line">	    <span class="string">&#x27;discounted&#x27;</span> =&gt; <span class="number">1</span></span><br><span class="line">	]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Do it in ONE sentence</span></span><br><span class="line"><span class="variable">$flight</span> = Flight::updateOrCreate(</span><br><span class="line">    [<span class="string">&#x27;departure&#x27;</span> =&gt; <span class="string">&#x27;Oakland&#x27;</span>, <span class="string">&#x27;destination&#x27;</span> =&gt; <span class="string">&#x27;San Diego&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;price&#x27;</span> =&gt; <span class="number">99</span>, <span class="string">&#x27;discounted&#x27;</span> =&gt; <span class="number">1</span>]</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="保存时移除缓存"><a href="#保存时移除缓存" class="headerlink" title="保存时移除缓存"></a>保存时移除缓存</h3><p>如果您缓存了一个键存储了 <code>posts</code> 这个集合，想在新增或更新时移除缓存键，可以在您的模型上调用静态的 saved 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// Forget cache key on storing or updating</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::boot();</span><br><span class="line">        <span class="built_in">static</span>::saved(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">           Cache::forget(<span class="string">&#x27;posts&#x27;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改Created-at和Updated-at的格式"><a href="#修改Created-at和Updated-at的格式" class="headerlink" title="修改Created_at和Updated_at的格式"></a>修改Created_at和Updated_at的格式</h3><p>想要改变 <code>created_at</code>的格式，您可以在模型中添加一个方法，如下所示:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCreatedAtFormattedAttribute</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;created_at-&gt;format(<span class="string">&#x27;H:i d, M Y&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你可以在需要改变时间格式时使用 <code>$entry-&gt;created_at_formatted</code> ，它会返回 <code>created_at</code> 的属性如同 <code>04:19 23, Aug 2020</code>。</p>
<p>你也可以用同样的方法更改 <code>updated_at</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUpdatedAtFormattedAttribute</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;updated_at-&gt;format(<span class="string">&#x27;H:i d, M Y&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在有需要的时候使用 <code>$entry-&gt;updated_at_formatted</code>。它会返回 <code>updated_at</code> 的属性如同: <code>04:19 23, Aug 2020</code> 。</p>
<h3 id="数组类型存储到-JSON-中"><a href="#数组类型存储到-JSON-中" class="headerlink" title="数组类型存储到 JSON 中"></a>数组类型存储到 JSON 中</h3><p>如果你的输入字段有一个数组需要存储为 JSON 格式，你可以在模型中使用 <code>$casts</code> 属性。 这里的 <code>images</code> 是 JSON 属性</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="variable">$casts</span> = [</span><br><span class="line">    <span class="string">&#x27;images&#x27;</span> =&gt; <span class="string">&#x27;array&#x27;</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>这样你可以以 JSON 格式存储它，但当你从 DB 中读取时，它会以数组方式使用。</p>
<h3 id="复制一个模型"><a href="#复制一个模型" class="headerlink" title="复制一个模型"></a>复制一个模型</h3><p>如果你有两个非常相似的模型（比如送货地址和账单地址），而且你想要复制其中一个作为另一个，你可以使用 replicate() 方法并更改一部分属性。</p>
<p><a target="_blank" rel="noopener" href="https://laravel.com/docs/8.x/eloquent#replicating-models">官方文档的示例</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$shipping</span> = Address::create([</span><br><span class="line">    <span class="string">&#x27;type&#x27;</span> =&gt; <span class="string">&#x27;shipping&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;line_1&#x27;</span> =&gt; <span class="string">&#x27;123 Example Street&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;city&#x27;</span> =&gt; <span class="string">&#x27;Victorville&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;state&#x27;</span> =&gt; <span class="string">&#x27;CA&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;postcode&#x27;</span> =&gt; <span class="string">&#x27;90001&#x27;</span>,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="variable">$billing</span> = <span class="variable">$shipping</span>-&gt;replicate()-&gt;fill([</span><br><span class="line">    <span class="string">&#x27;type&#x27;</span> =&gt; <span class="string">&#x27;billing&#x27;</span></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="variable">$billing</span>-&gt;save();</span><br></pre></td></tr></table></figure>

<h3 id="降低内存占用"><a href="#降低内存占用" class="headerlink" title="降低内存占用"></a>降低内存占用</h3><p>有时我们需要将大量的数据加载到内存中，比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$orders</span> = Order::all();</span><br></pre></td></tr></table></figure>

<p>但如果我们有非常庞大的数据库，这可能会很慢，因为 <code>Laravel </code> 会准备好模型类的对象。在这种情况下，<code>Laravel </code>有一个很方便的函数 <code>toBase()</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$orders</span> = Order::toBase()-&gt;get();</span><br><span class="line"><span class="comment">//$orders 将是一个由`StdClass`组成的 `Illuminate\Support\Collection`</span></span><br></pre></td></tr></table></figure>

<p>通过调用这个方法，它将从数据库中获取数据，但它不会准备模型类。同时，向 <code>get()</code> 方法传递一个字段数组通常是个好主意，这样可以防止从数据库中获取所有字段。</p>
<h3 id="忽略-fillable-guarded-并强制执行"><a href="#忽略-fillable-guarded-并强制执行" class="headerlink" title="忽略 $fillable/$guarded 并强制执行"></a>忽略 $fillable/$guarded 并强制执行</h3><p>如果你为其他开发者创建了一个 Laravel 模板, 然后你不能控制他们以后会在模型的 $fillable/$guarded 中填写什么，你可以使用 forceFill()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$team</span>-&gt;update([<span class="string">&#x27;name&#x27;</span> =&gt; <span class="variable">$request</span>-&gt;name])</span><br></pre></td></tr></table></figure>

<p>如果 name 不在<code>team</code>模型的 <code>$fillable</code> 中，怎么办？或者如果根本就没有 <code>$fillable/$guarded</code>， 怎么办？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$team</span>-&gt;forceFill([<span class="string">&#x27;name&#x27;</span> =&gt; <span class="variable">$request</span>-&gt;name])</span><br></pre></td></tr></table></figure>

<p>这将忽略该查询的 $fillable 并强制执行。</p>
<h3 id="3层父子级结构"><a href="#3层父子级结构" class="headerlink" title="3层父子级结构"></a>3层父子级结构</h3><p>If you have a 3-level structure of parent-children, like categories in an e-shop, and you want to show the number of products on the third level, you can use <code>with(&#39;yyy.yyy&#39;)</code> and then add <code>withCount()</code> as a condition</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> <span class="title">extend</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$categories</span> = Category::query()</span><br><span class="line">            -&gt;whereNull(<span class="string">&#x27;category_id&#x27;</span>)</span><br><span class="line">            -&gt;with([<span class="string">&#x27;subcategories.subcategories&#x27;</span> =&gt; <span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$query</span></span>) </span>&#123;</span><br><span class="line">                <span class="variable">$query</span>-&gt;withCount(<span class="string">&#x27;products&#x27;</span>);</span><br><span class="line">            &#125;])-&gt;get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">subcategories</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasMany(Category::class);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">products</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasMany(Product::class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul&gt;</span><br><span class="line">    @<span class="keyword">foreach</span>(<span class="variable">$categories</span> <span class="keyword">as</span> <span class="variable">$category</span>)</span><br><span class="line">        &lt;li&gt;</span><br><span class="line">            &#123;&#123; <span class="variable">$category</span>-&gt;name &#125;&#125;</span><br><span class="line">            @<span class="keyword">if</span> (<span class="variable">$category</span>-&gt;subcategories)</span><br><span class="line">                &lt;ul&gt;</span><br><span class="line">                @<span class="keyword">foreach</span>(<span class="variable">$category</span>-&gt;subcategories <span class="keyword">as</span> <span class="variable">$subcategory</span>)</span><br><span class="line">                    &lt;li&gt;</span><br><span class="line">                        &#123;&#123; <span class="variable">$subcategory</span>-&gt;name &#125;&#125;</span><br><span class="line">                        @<span class="keyword">if</span> (<span class="variable">$subcategory</span>-&gt;subcategories)</span><br><span class="line">                            &lt;ul&gt;</span><br><span class="line">                                @<span class="keyword">foreach</span> (<span class="variable">$subcategory</span>-&gt;subcategories <span class="keyword">as</span> <span class="variable">$subcategory</span>)</span><br><span class="line">                                    &lt;li&gt;&#123;&#123; <span class="variable">$subcategory</span>-&gt;name &#125;&#125; (&#123;&#123; <span class="variable">$subcategory</span>-&gt;product_count &#125;&#125;)&lt;/li&gt;</span><br><span class="line">                                @<span class="keyword">endforeach</span></span><br><span class="line">                            &lt;/ul&gt;</span><br><span class="line">                        @<span class="keyword">endif</span></span><br><span class="line">                    &lt;/li&gt;</span><br><span class="line">                @<span class="keyword">endforeach</span></span><br><span class="line">                &lt;/ul&gt;</span><br><span class="line">            @<span class="keyword">endif</span></span><br><span class="line">        &lt;/li&gt;</span><br><span class="line">    @<span class="keyword">endforeach</span>           </span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure>

<h3 id="使用-find-来搜索更多的记录"><a href="#使用-find-来搜索更多的记录" class="headerlink" title="使用 find() 来搜索更多的记录"></a>使用 find() 来搜索更多的记录</h3><p>你不仅可以用 find() 来搜索单条记录，还可以用 IDs 的集合来搜索更多的记录，方法如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> Product::whereIn(<span class="string">&#x27;id&#x27;</span>, <span class="keyword">$this</span>-&gt;productIDs)-&gt;get();</span><br></pre></td></tr></table></figure>

<p>这么做:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> Product::find(<span class="keyword">$this</span>-&gt;productIDs)</span><br></pre></td></tr></table></figure>

<h3 id="失败时执行任何操作"><a href="#失败时执行任何操作" class="headerlink" title="失败时执行任何操作"></a>失败时执行任何操作</h3><p>当查询一条记录时，如果没有找到，你可能想执行一些操作。除了用 -&gt;firstOrFail() 会抛出 404 之外，你可以在失败时执行任何操作，只需要使用 </p>
<p><code>-&gt;firstOr(function() &#123; ... &#125;)</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$model</span> = Flight::where(<span class="string">&#x27;legs&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="number">3</span>)-&gt;firstOr(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="检查记录是否存在否则显示-404"><a href="#检查记录是否存在否则显示-404" class="headerlink" title="检查记录是否存在否则显示 404"></a>检查记录是否存在否则显示 404</h3><p>不要使用 find() ，然后再检查记录是否存在，使用 <code>findOrFail()</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$product</span> = Product::find(<span class="variable">$id</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$product</span>) &#123;</span><br><span class="line">    abort(<span class="number">404</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$product</span>-&gt;update(<span class="variable">$productDataArray</span>);</span><br></pre></td></tr></table></figure>

<p>更简单的方法:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$product</span> = Product::findOrFail(<span class="variable">$id</span>); <span class="comment">// shows 404 if not found</span></span><br><span class="line"><span class="variable">$product</span>-&gt;update(<span class="variable">$productDataArray</span>);</span><br></pre></td></tr></table></figure>

<h3 id="条件语句为否时中止"><a href="#条件语句为否时中止" class="headerlink" title="条件语句为否时中止"></a>条件语句为否时中止</h3><p>可以使用 <code>abort_if()</code> 作为判断条件和抛出错误页面的快捷方式。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$product</span> = Product::findOrFail(<span class="variable">$id</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$product</span>-&gt;user_id != auth()-&gt;user()-&gt;id)&#123;</span><br><span class="line">    abort(<span class="number">403</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更简单的方法:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* abort_if(CONDITION, ERROR_CODE) */</span></span><br><span class="line"><span class="variable">$product</span> = Product::findOrFail(<span class="variable">$id</span>);</span><br><span class="line">abort_if (<span class="variable">$product</span>-&gt;user_id != auth()-&gt;user()-&gt;id, <span class="number">403</span>)</span><br></pre></td></tr></table></figure>

<h3 id="在删除模型之前执行任何额外的操作"><a href="#在删除模型之前执行任何额外的操作" class="headerlink" title="在删除模型之前执行任何额外的操作"></a>在删除模型之前执行任何额外的操作</h3><p>我们可以使用 <code>Model::delete()</code> 执行额外的操作来覆盖原本的删除方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// App\Models\User.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//extra steps here whatever you want</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//now perform the normal deletion</span></span><br><span class="line">	Model::delete();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="当你需要在保存数据到数据库时自动填充一个字段"><a href="#当你需要在保存数据到数据库时自动填充一个字段" class="headerlink" title="当你需要在保存数据到数据库时自动填充一个字段"></a>当你需要在保存数据到数据库时自动填充一个字段</h3><p>当你需要在保存数据到数据库时自动填充一个字段 （例如: slug），使用模型观察者来代替重复编写代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Str</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>:boot();</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">static</span>::saving(<span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$model</span></span>) </span>&#123;</span><br><span class="line">            <span class="variable">$model</span>-&gt;slug = Str::slug(<span class="variable">$model</span>-&gt;title);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="获取查询语句的额外信息"><a href="#获取查询语句的额外信息" class="headerlink" title="获取查询语句的额外信息"></a>获取查询语句的额外信息</h3><p>你可以使用 <code>explain()</code> 方法来获取查询语句的额外信息</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Book::where(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;Ruskin Bond&#x27;</span>)-&gt;explain()-&gt;dd();</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Illuminate\Support\Collection &#123;<span class="comment">#5344</span></span><br><span class="line">    all: [</span><br><span class="line">        &#123;<span class="comment">#15407</span></span><br><span class="line">            +<span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            +<span class="string">&quot;select_type&quot;</span>: <span class="string">&quot;SIMPLE&quot;</span>,</span><br><span class="line">            +<span class="string">&quot;table&quot;</span>: <span class="string">&quot;books&quot;</span>,</span><br><span class="line">            +<span class="string">&quot;partitions&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            +<span class="string">&quot;type&quot;</span>: <span class="string">&quot;ALL&quot;</span>,</span><br><span class="line">            +<span class="string">&quot;possible_keys&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            +<span class="string">&quot;key&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            +<span class="string">&quot;key_len&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            +<span class="string">&quot;ref&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            +<span class="string">&quot;rows&quot;</span>: <span class="number">9</span>,</span><br><span class="line">            +<span class="string">&quot;filtered&quot;</span>: <span class="number">11.11111164093</span>,</span><br><span class="line">            +<span class="string">&quot;Extra&quot;</span>: <span class="string">&quot;Using where&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="在-Laravel-中使用doesntExist-方法"><a href="#在-Laravel-中使用doesntExist-方法" class="headerlink" title="在 Laravel 中使用doesntExist()方法"></a>在 Laravel 中使用doesntExist()方法</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一个例子</span></span><br><span class="line"><span class="keyword">if</span> ( <span class="number">0</span> === <span class="variable">$model</span>-&gt;where(<span class="string">&#x27;status&#x27;</span>, <span class="string">&#x27;pending&#x27;</span>)-&gt;count() ) &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我不关心它有多少数据只要它是0</span></span><br><span class="line"><span class="comment">// Laravel 的 exists() 方法会很清晰</span></span><br><span class="line"><span class="keyword">if</span> ( ! <span class="variable">$model</span>-&gt;where(<span class="string">&#x27;status&#x27;</span>, <span class="string">&#x27;pending&#x27;</span>)-&gt;exists() ) &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 但我发现上面这条语句中的！很容易被忽略。</span></span><br><span class="line"><span class="comment">// 那么 doesntExist() 方法会让这个例子更加清晰</span></span><br><span class="line"><span class="keyword">if</span> ( <span class="variable">$model</span>-&gt;where(<span class="string">&#x27;status&#x27;</span>, <span class="string">&#x27;pending&#x27;</span>)-&gt;doesntExist() ) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="在一些模型的-boot-方法中自动调用一个特性"><a href="#在一些模型的-boot-方法中自动调用一个特性" class="headerlink" title="在一些模型的 boot () 方法中自动调用一个特性"></a>在一些模型的 boot () 方法中自动调用一个特性</h3><p>如果你有一个特性，你想把它添加到几个模型中，自动调用它们的 <code>boot()</code> 方法，你可以把特性的方法作为boot （特性名称）来调用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Transaction</span> <span class="keyword">extends</span>  <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">MultiTenantModelTrait</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span> <span class="keyword">extends</span>  <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">MultiTenantModelTrait</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">MultiTenantModelTrait</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// This method&#x27;s name is boot[TraitName]</span></span><br><span class="line">    <span class="comment">// It will be auto-called as boot() of Transaction/Task</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">bootMultiTenantModelTrait</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">static</span>::creating(<span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$model</span></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="variable">$isAdmin</span>) &#123;</span><br><span class="line">                <span class="variable">$isAdmin</span>-&gt;created_by_id = auth()-&gt;id();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Laravel-的-find-方法，比只传一个-ID-更多的选择"><a href="#Laravel-的-find-方法，比只传一个-ID-更多的选择" class="headerlink" title="Laravel 的 find () 方法，比只传一个 ID 更多的选择"></a>Laravel 的 find () 方法，比只传一个 ID 更多的选择</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 find($id) 方法中第二个参数可以是返回字段</span></span><br><span class="line">Studdents::find(<span class="number">1</span>, [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;father_name&#x27;</span>]);</span><br><span class="line"><span class="comment">// 这样我们可以查询 ID 为 &#x27;1&#x27; 并返回 name , father_name 字段</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们可以用数组的方式传递更多的 ID</span></span><br><span class="line">Studdents::find([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>], [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;father_name&#x27;</span>]);</span><br><span class="line"><span class="comment">// 输出: ID 为 1,2,3 并返回他们的 name , father_name 字段</span></span><br></pre></td></tr></table></figure>

<h3 id="在-Laravel-中有两种常见的方法来确定一个表是否为空表"><a href="#在-Laravel-中有两种常见的方法来确定一个表是否为空表" class="headerlink" title="在 Laravel 中有两种常见的方法来确定一个表是否为空表"></a>在 Laravel 中有两种常见的方法来确定一个表是否为空表</h3><p>在 Laravel 中，有两种常见的方法来确定一个表是否为空表。 直接在模型上使用 <code>exists()</code> 或者 <code>count()</code><br>不等于一个返回严格的布尔值，另一个返回一个整数，你都可以在条件语句中使用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (\App\Models\User::exists()) &#123;</span><br><span class="line">        <span class="comment">// returns boolean true or false if the table has any saved rows</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (\App\Models\User::count()) &#123;</span><br><span class="line">        <span class="comment">// returns the count of rows in the table</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="如何避免-property-of-non-object-错误"><a href="#如何避免-property-of-non-object-错误" class="headerlink" title="如何避免 property of non-object 错误"></a>如何避免 property of non-object 错误</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设定默认模型</span></span><br><span class="line"><span class="comment">// 假设你有一篇 Post （帖子） 属于一个 Author （作者），代码如下:</span></span><br><span class="line"><span class="variable">$post</span>-&gt;author-&gt;name;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当然你可以像这样阻止错误:</span></span><br><span class="line"><span class="variable">$post</span>-&gt;author-&gt;name ?? <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line">@<span class="variable">$post</span>-&gt;author-&gt;name</span><br><span class="line"></span><br><span class="line"><span class="comment">// 但你可以在Eloquent关系层面上做到这一点。</span></span><br><span class="line"><span class="comment">// 如果没有作者关联帖子，这种关系将返回一个空的App/Author模型。</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">author</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsTo(<span class="string">&#x27;App\Author&#x27;</span>)-&gt;withDefault();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">author</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsTo(<span class="string">&#x27;App\Author&#x27;</span>)-&gt;withDefault([</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;Guest Author&#x27;</span></span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Eloquent-数据改变后获取原始数据"><a href="#Eloquent-数据改变后获取原始数据" class="headerlink" title="Eloquent 数据改变后获取原始数据"></a>Eloquent 数据改变后获取原始数据</h3><p>Eloquent 模型数据改变后，你可以使用 getOriginal () 方法来获取原始数据</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = App\User::first();</span><br><span class="line"><span class="variable">$user</span>-&gt;name; <span class="comment">// John</span></span><br><span class="line"><span class="variable">$user</span>-&gt;name = <span class="string">&quot;Peter&quot;</span>; <span class="comment">// Peter</span></span><br><span class="line"><span class="variable">$user</span>-&gt;getOriginal(<span class="string">&#x27;name&#x27;</span>); <span class="comment">// John</span></span><br><span class="line"><span class="variable">$user</span>-&gt;getOriginal(); <span class="comment">// Original $user record</span></span><br></pre></td></tr></table></figure>

<h3 id="一种更简单创建数据库的方法"><a href="#一种更简单创建数据库的方法" class="headerlink" title="一种更简单创建数据库的方法"></a>一种更简单创建数据库的方法</h3><p>Laravel 还可以使用 .sql 文件来更简单的创建数据库</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DB::unprepared(</span><br><span class="line">    file_get_contents(<span class="keyword">__DIR__</span> . <span class="string">&#x27;./dump.sql&#x27;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="Query构造器的crossJoinSub方法"><a href="#Query构造器的crossJoinSub方法" class="headerlink" title="Query构造器的crossJoinSub方法"></a>Query构造器的crossJoinSub方法</h3><p>使用CROSS JOIN交叉连接</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">DB</span>;</span><br><span class="line"><span class="variable">$totalQuery</span> = DB::table(<span class="string">&#x27;orders&#x27;</span>)-&gt;selectRaw(<span class="string">&#x27;SUM(price) as total&#x27;</span>);</span><br><span class="line">DB::table(<span class="string">&#x27;orders&#x27;</span>)</span><br><span class="line">    -&gt;select(<span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">    -&gt;crossJoinSub(<span class="variable">$totalQuery</span>, <span class="string">&#x27;overall&#x27;</span>)</span><br><span class="line">    -&gt;selectRaw(<span class="string">&#x27;(price / overall.total) * 100 AS percent_of_total&#x27;</span>)</span><br><span class="line">    -&gt;get();</span><br></pre></td></tr></table></figure>

<h3 id="belongsToMany的中间表命名"><a href="#belongsToMany的中间表命名" class="headerlink" title="belongsToMany的中间表命名"></a>belongsToMany的中间表命名</h3><p>为了决定 关系表的中间表, Eloquent将按字母顺序连接两个相关的型号名称。</p>
<p>这意味着可以这样添加“Post”和“Tag”之间的连接：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$table</span> = <span class="string">&#x27;posts&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tags</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsToMany(Tag::class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是，您可以自由重写此约定，并且需要在第二个参数中指定联接表。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$table</span> = <span class="string">&#x27;posts&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tags</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsToMany(Tag::class, <span class="string">&#x27;posts_tags&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果希望明确说明主键，还可以将其作为第三个和第四个参数提供。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$table</span> = <span class="string">&#x27;posts&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tags</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsToMany(Tag::class, <span class="string">&#x27;post_tag&#x27;</span>, <span class="string">&#x27;post_id&#x27;</span>, <span class="string">&#x27;tag_id&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="根据Pivot字段排序"><a href="#根据Pivot字段排序" class="headerlink" title="根据Pivot字段排序"></a>根据Pivot字段排序</h3><p><code>BelongsToMany::orderByPivot()</code> 允许你直接对<code>BelongsToMany </code>关系查询的结果集进行排序。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$table</span> = <span class="string">&#x27;tags&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$table</span> = <span class="string">&#x27;posts&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tags</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsToMany(Tag::class, <span class="string">&#x27;posts_tags&#x27;</span>, <span class="string">&#x27;post_id&#x27;</span>, <span class="string">&#x27;tag_id&#x27;</span>)</span><br><span class="line">            -&gt;using(PostTagPivot::class)</span><br><span class="line">            -&gt;withTimestamps()</span><br><span class="line">            -&gt;withPivot(<span class="string">&#x27;flag&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostTagPivot</span> <span class="keyword">extends</span> <span class="title">Pivot</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$table</span> = <span class="string">&#x27;posts_tags&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Somewhere in the Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getPostTags</span>(<span class="params"><span class="variable">$id</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Post::findOrFail(<span class="variable">$id</span>)-&gt;tags()-&gt;orderByPivot(<span class="string">&#x27;flag&#x27;</span>, <span class="string">&#x27;desc&#x27;</span>)-&gt;get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="从数据库中查询一条记录"><a href="#从数据库中查询一条记录" class="headerlink" title="从数据库中查询一条记录"></a>从数据库中查询一条记录</h3><p><code>sole()</code>方法将会只返回一条匹配标准的记录。如果没找到，将会抛出<code>NoRecordsFoundException</code> 异常。如果发现了多条记录，抛出<code>MultipleRecordsFoundException</code> 异常</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DB::table(<span class="string">&#x27;products&#x27;</span>)-&gt;where(<span class="string">&#x27;ref&#x27;</span>, <span class="string">&#x27;#123&#x27;</span>)-&gt;sole();</span><br></pre></td></tr></table></figure>

<h3 id="记录自动分块"><a href="#记录自动分块" class="headerlink" title="记录自动分块"></a>记录自动分块</h3><p>与<code>each()</code>相同，但是更简单使用。<code>chunks</code>自动将记录分成多块。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> User::orderBy(<span class="string">&#x27;name&#x27;</span>)-&gt;chunkMap(<span class="function"><span class="keyword">fn</span> (<span class="params"><span class="variable">$user</span></span>) =&gt;</span> [</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span> =&gt; <span class="variable">$user</span>-&gt;id,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span> =&gt; <span class="variable">$user</span>-&gt;name,</span><br><span class="line">]), <span class="number">25</span>);</span><br></pre></td></tr></table></figure>

<h3 id="定时清理过期记录中的模型"><a href="#定时清理过期记录中的模型" class="headerlink" title="定时清理过期记录中的模型"></a>定时清理过期记录中的模型</h3><p>定期清理过时记录的模型。有了这个特性，Laravel将自动完成这项工作，只需调整内核类中<code>model:prune</code>命令的频率</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Prunable</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Prunable</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the prunable model query.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Database\Eloquent\Builder</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">prunable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">static</span>::where(<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;&lt;=&#x27;</span>, now()-&gt;subMonth());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此外，在修剪方法中，可以设置删除模型之前必须执行的操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">pruning</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Removing additional resources,</span></span><br><span class="line">    <span class="comment">// associated with the model. For example, files.</span></span><br><span class="line">    Storage::disk(<span class="string">&#x27;s3&#x27;</span>)-&gt;delete(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="不变的日期和对它们的强制转换"><a href="#不变的日期和对它们的强制转换" class="headerlink" title="不变的日期和对它们的强制转换"></a>不变的日期和对它们的强制转换</h3><p>Laravel 8.53 介绍了<code>immutable_date</code> 和<code>immutable_datetime</code> 将日期转换为Immutable`.</p>
<p>转换成<code>CarbonImmutable </code>，而不是常规的<code>Carbon </code>实例。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$casts</span> = [</span><br><span class="line">        <span class="string">&#x27;date_field&#x27;</span>     =&gt; <span class="string">&#x27;immutable_date&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;datetime_field&#x27;</span> =&gt; <span class="string">&#x27;immutable_datetime&#x27;</span>,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="findorfail方法也接收ids数组"><a href="#findorfail方法也接收ids数组" class="headerlink" title="findorfail方法也接收ids数组"></a>findorfail方法也接收ids数组</h3><p>findorfail方法也接收ids数组。若无ids被找到 则失败。</p>
<p>若你想拿到一个模型的集合 并不想检测返回数量为你想得到的数量时很好用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">User::create([<span class="string">&#x27;id&#x27;</span> =&gt; <span class="number">1</span>]);</span><br><span class="line">User::create([<span class="string">&#x27;id&#x27;</span> =&gt; <span class="number">2</span>);</span><br><span class="line">User::create([<span class="string">&#x27;id&#x27;</span> =&gt; <span class="number">3</span>]);</span><br><span class="line"><span class="comment">// Retrives the user...</span></span><br><span class="line"><span class="variable">$user</span> = User::findOrFail(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// Throws a 404 because the user doesn&#x27;t exist...</span></span><br><span class="line">User::findOrFail(<span class="number">99</span>);</span><br><span class="line"><span class="comment">// Retrives all 3 users...</span></span><br><span class="line"><span class="variable">$users</span> = User::findOrFail([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="comment">// Throws because it is unable to find *all* of the users</span></span><br><span class="line">User::findOrFail([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">99</span>]);</span><br></pre></td></tr></table></figure>

<h3 id="从你的数据库中自动移除模型prunableTrait"><a href="#从你的数据库中自动移除模型prunableTrait" class="headerlink" title="从你的数据库中自动移除模型prunableTrait"></a>从你的数据库中自动移除模型prunableTrait</h3><p>Laravel 8.50新特性:</p>
<p>你可以使用<code>prunable trait</code>从你的数据库中自动移除模型。举例:你可以在几天后永久移除软删除的模型。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">SoftDeletes</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Add Prunable trait</span></span><br><span class="line">    <span class="keyword">use</span> <span class="title">Prunable</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">prunable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Files matching this query will be pruned</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">static</span>::query()-&gt;where(<span class="string">&#x27;deleted_at&#x27;</span>, <span class="string">&#x27;&lt;=&#x27;</span>, now()-&gt;subDays(<span class="number">14</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">pruning</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Remove the file from s3 before deleting the model</span></span><br><span class="line">        Storage::disk(<span class="string">&#x27;s3&#x27;</span>)-&gt;delete(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Add PruneCommand to your shedule (app/Console/Kernel.php)</span></span><br><span class="line"><span class="variable">$schedule</span>-&gt;command(PruneCommand::class)-&gt;daily();</span><br></pre></td></tr></table></figure>

<h3 id="日期转换"><a href="#日期转换" class="headerlink" title="日期转换"></a>日期转换</h3><p>当标记改变时 原来用布尔值来控制模型的可见性，现在可以使用``something_at<code> </code>替换。比如 一个产品变成可见:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Migration</span></span><br><span class="line">Schema::table(<span class="string">&#x27;products&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">Blueprint <span class="variable">$table</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$table</span>-&gt;datetime(<span class="string">&#x27;live_at&#x27;</span>)-&gt;nullable();</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// In your model</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">live</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !is_null(<span class="keyword">$this</span>-&gt;live_at);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Also in your model</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$dates</span> = [</span><br><span class="line">    <span class="string">&#x27;live_at&#x27;</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<h3 id="多模型更新插入"><a href="#多模型更新插入" class="headerlink" title="多模型更新插入"></a>多模型更新插入</h3><p><code>upsert()</code>方法将插入/更新多个记录。</p>
<ul>
<li>第一个参数数组:要更新/插入的值</li>
<li>第二个:查询表达式中使用的唯一标识列</li>
<li>第三个:若记录存在 你想要更新的列</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Flight::upsert([</span><br><span class="line">    [<span class="string">&#x27;departure&#x27;</span> =&gt; <span class="string">&#x27;Oakland&#x27;</span>, <span class="string">&#x27;destination&#x27;</span> =&gt; <span class="string">&#x27;San Diego&#x27;</span>, <span class="string">&#x27;price&#x27;</span> =&gt; <span class="number">99</span>],</span><br><span class="line">    [<span class="string">&#x27;departure&#x27;</span> =&gt; <span class="string">&#x27;Chicago&#x27;</span>, <span class="string">&#x27;destination&#x27;</span> =&gt; <span class="string">&#x27;New York&#x27;</span>, <span class="string">&#x27;price&#x27;</span> =&gt; <span class="number">150</span>],</span><br><span class="line">], [<span class="string">&#x27;departure&#x27;</span>, <span class="string">&#x27;destination&#x27;</span>], [<span class="string">&#x27;price&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<h3 id="过滤结果集之后获取查询构造器"><a href="#过滤结果集之后获取查询构造器" class="headerlink" title="过滤结果集之后获取查询构造器"></a>过滤结果集之后获取查询构造器</h3><p>你可以使用 <code>toQuery()</code> 在过滤结果集之后获取查询构造器。</p>
<p>该方法在内部使用集合的第一个模型 并使用集合模型上的“whereKey”比较器。(此处翻译拗口 存疑。但是使用方法很明确。)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Retrieve all logged_in users</span></span><br><span class="line"><span class="variable">$loggedInUsers</span> = User::where(<span class="string">&#x27;logged_in&#x27;</span>, <span class="literal">true</span>)-&gt;get();</span><br><span class="line"><span class="comment">// Filter them using a Collection method or php filtering</span></span><br><span class="line"><span class="variable">$nthUsers</span> = <span class="variable">$loggedInUsers</span>-&gt;nth(<span class="number">3</span>);</span><br><span class="line"><span class="comment">// You can&#x27;t do this on the collection</span></span><br><span class="line"><span class="variable">$nthUsers</span>-&gt;update(<span class="comment">/* ... */</span>);</span><br><span class="line"><span class="comment">// But you can retrieve the Builder using -&gt;toQuery()</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$nthUsers</span>-&gt;isNotEmpty()) &#123;</span><br><span class="line">    <span class="variable">$nthUsers</span>-&gt;toQuery()-&gt;update(<span class="comment">/* ... */</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="选择聚合计算相关模型"><a href="#选择聚合计算相关模型" class="headerlink" title="选择聚合计算相关模型"></a>选择聚合计算相关模型</h3><p>选择聚合计算相关模型。</p>
<p>需要指出的是在一组相关模型上使用<code>count</code>方法要慢一点。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In your controller</span></span><br><span class="line"><span class="variable">$user</span> = User::withCount(<span class="string">&#x27;articles&#x27;</span>);</span><br><span class="line"><span class="comment">// Or, to add a constraint to the aggregate</span></span><br><span class="line"><span class="variable">$user</span> = User::withCount([</span><br><span class="line">    <span class="string">&#x27;articles&#x27;</span> =&gt; <span class="function"><span class="keyword">fn</span> (<span class="params"><span class="variable">$query</span></span>) =&gt;</span> <span class="variable">$query</span>-&gt;live();</span><br><span class="line">]);</span><br><span class="line"><span class="comment">// In your view</span></span><br><span class="line"><span class="variable">$user</span>-&gt;articles_count</span><br><span class="line"><span class="comment">// Instead of</span></span><br><span class="line"><span class="variable">$user</span>-&gt;articles-&gt;count();</span><br></pre></td></tr></table></figure>

<h3 id="自定义强制转换"><a href="#自定义强制转换" class="headerlink" title="自定义强制转换"></a>自定义强制转换</h3><p>你可以自定义强制转换来让<code>Laravel</code>自动格式化你的模型数据。</p>
<p>下面是一个在检索或更改用户名时将其大写的示例。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CapitalizeWordsCast</span> <span class="keyword">implements</span> <span class="title">CastsAttributes</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$model</span>, <span class="keyword">string</span> <span class="variable">$key</span>, <span class="variable">$value</span>, <span class="keyword">array</span> <span class="variable">$attributes</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ucwords(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"><span class="variable">$model</span>, <span class="keyword">string</span> <span class="variable">$key</span>, <span class="variable">$value</span>, <span class="keyword">array</span> <span class="variable">$attributes</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ucwords(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$casts</span> = [</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>  =&gt; CapitalizeWordsCast::class,</span><br><span class="line">        <span class="string">&#x27;email&#x27;</span> =&gt; <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">    ]; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="保存中不要触发事件"><a href="#保存中不要触发事件" class="headerlink" title="保存中不要触发事件"></a>保存中不要触发事件</h3><p>若你不想触发模型事件 使用<code>saveQuietly()</code>方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">quietly</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$user</span> = User::findOrFail(<span class="number">1</span>);</span><br><span class="line">    <span class="variable">$user</span>-&gt;name = <span class="string">&#x27;Martin Joo&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Will not trigger any model event</span></span><br><span class="line">    <span class="variable">$user</span>-&gt;saveQuietly();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="基于相关模型的平均值或总数排序"><a href="#基于相关模型的平均值或总数排序" class="headerlink" title="基于相关模型的平均值或总数排序"></a>基于相关模型的平均值或总数排序</h3><p>你是否曾需要基于关系模型的平均值或总数来排序？</p>
<p>这很简单</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bestBooks</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Book::query()</span><br><span class="line">        -&gt;withAvg(<span class="string">&#x27;ratings as average_rating&#x27;</span>, <span class="string">&#x27;rating&#x27;</span>)</span><br><span class="line">        -&gt;orderByDesc(<span class="string">&#x27;average_rating&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="返回事务结果"><a href="#返回事务结果" class="headerlink" title="返回事务结果"></a>返回事务结果</h3><p>若你有一个<code>DB</code>事务 并且你想返回它的结果 至少有两种方法:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. You can pass the parameter by reference</span></span><br><span class="line"><span class="variable">$invoice</span> = <span class="literal">NULL</span>;</span><br><span class="line">DB::transaction(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="keyword">use</span> (<span class="params">&amp;<span class="variable">$invoice</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$invoice</span> = Invoice::create(...);</span><br><span class="line">    <span class="variable">$invoice</span>-&gt;items()-&gt;attach(...);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 2. Or shorter: just return trasaction result</span></span><br><span class="line"><span class="variable">$invoice</span> = DB::transaction(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$invoice</span> = Invoice::create(...);</span><br><span class="line">    <span class="variable">$invoice</span>-&gt;items()-&gt;attach(...);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$invoice</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="从query中移除多个公共scope"><a href="#从query中移除多个公共scope" class="headerlink" title="从query中移除多个公共scope"></a>从query中移除多个公共scope</h3><p>当使用<code>Global Scopes</code>时 你不仅可以使用多个 <code>scope</code> 而且可以在不需要的时候通过提供的``withoutGlobalScopes`方法移除他们</p>
<p><a target="_blank" rel="noopener" href="https://laravel.com/docs/8.x/eloquent#global-scopes">Link to docs</a></p>
<h3 id="JSON列属性排序"><a href="#JSON列属性排序" class="headerlink" title="JSON列属性排序"></a>JSON列属性排序</h3><p>你可以使用JSON列属性排序</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JSON column example:</span></span><br><span class="line"><span class="comment">// bikes.settings = &#123;&quot;is_retired&quot;: false&#125;</span></span><br><span class="line"><span class="variable">$bikes</span> = Bike::where(<span class="string">&#x27;athlete_id&#x27;</span>, <span class="keyword">$this</span>-&gt;athleteId)</span><br><span class="line">        -&gt;orderBy(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        -&gt;orderByDesc(<span class="string">&#x27;settings-&gt;is_retired&#x27;</span>)</span><br><span class="line">        -&gt;get();</span><br></pre></td></tr></table></figure>

<h3 id="从第一个结果中获取单列的值"><a href="#从第一个结果中获取单列的值" class="headerlink" title="从第一个结果中获取单列的值"></a>从第一个结果中获取单列的值</h3><p>你可以使用<code>value</code>方法从第一个结果中获取单列的值。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Instead of</span></span><br><span class="line">Integration::where(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;foo&#x27;</span>)-&gt;first()-&gt;active;</span><br><span class="line"><span class="comment">// You can use</span></span><br><span class="line">Integration::where(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;foo&#x27;</span>)-&gt;value(<span class="string">&#x27;active&#x27;</span>);</span><br><span class="line"><span class="comment">// or this to throw an exception if no records found</span></span><br><span class="line">Integration::where(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;foo&#x27;</span>)-&gt;valueOrFail(<span class="string">&#x27;active&#x27;</span>)<span class="string">&#x27;;</span></span><br></pre></td></tr></table></figure>

<h3 id="检测模型属性是否被修改"><a href="#检测模型属性是否被修改" class="headerlink" title="检测模型属性是否被修改"></a>检测模型属性是否被修改</h3><p>想知道您对模型所做的更改是否改变了键的值吗？没问题，只需<code>originalIsEquivalent</code>方法即可。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = User::first(); <span class="comment">// [&#x27;name&#x27; =&gt; &quot;John&#x27;]</span></span><br><span class="line"><span class="variable">$user</span>-&gt;name = <span class="string">&#x27;John&#x27;</span>;</span><br><span class="line"><span class="variable">$user</span>-&gt;originalIsEquivalent(<span class="string">&#x27;name&#x27;</span>); <span class="comment">// true</span></span><br><span class="line"><span class="variable">$user</span>-&gt;name = <span class="string">&#x27;David&#x27;</span>; <span class="comment">// Set directly</span></span><br><span class="line"><span class="variable">$user</span>-&gt;fill([<span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;David&#x27;</span>]); <span class="comment">// Or set via fill</span></span><br><span class="line"><span class="variable">$user</span>-&gt;originalIsEquivalent(<span class="string">&#x27;name&#x27;</span>); <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<h3 id="定义访问器与修改器的新方法"><a href="#定义访问器与修改器的新方法" class="headerlink" title="定义访问器与修改器的新方法"></a>定义访问器与修改器的新方法</h3><p>Laravel 8.77:定义访问器与修改器的新方法 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Before, two-method approach</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setTitleAttribute</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;attributes[<span class="string">&#x27;title&#x27;</span>] = strtolower(<span class="variable">$value</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getTitleAttribute</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> strtoupper(<span class="variable">$value</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// New approach</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">title</span>(<span class="params"></span>): <span class="title">Attribute</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Attribute(</span><br><span class="line">        get: <span class="function"><span class="keyword">fn</span> (<span class="params"><span class="variable">$value</span></span>) =&gt;</span> strtoupper(<span class="variable">$value</span>),</span><br><span class="line">        set: <span class="function"><span class="keyword">fn</span> (<span class="params"><span class="variable">$value</span></span>) =&gt;</span> strtolower(<span class="variable">$value</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="另外一种定义访问器与修改器的方法"><a href="#另外一种定义访问器与修改器的方法" class="headerlink" title="另外一种定义访问器与修改器的方法"></a>另外一种定义访问器与修改器的方法</h3><p>在一些模型中想用同样的修改器 访问器 可以自定义转换。</p>
<p>只需要创建一个类 实现 ``CastsAttributes` 实现两个方法</p>
<ul>
<li>get 标识模型应当从数据库如何拿到</li>
<li>set 标识数据应当如何存储到数据库</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Casts</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Carbon</span>\<span class="title">Carbon</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">CastsAttributes</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimestampsCast</span> <span class="keyword">implements</span> <span class="title">CastsAttributes</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$model</span>, <span class="keyword">string</span> <span class="variable">$key</span>, <span class="variable">$value</span>, <span class="keyword">array</span> <span class="variable">$attributes</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Carbon::parse(<span class="variable">$value</span>)-&gt;diffForHumans();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"><span class="variable">$model</span>, <span class="keyword">string</span> <span class="variable">$key</span>, <span class="variable">$value</span>, <span class="keyword">array</span> <span class="variable">$attributes</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Carbon::parse(<span class="variable">$value</span>)-&gt;format(<span class="string">&#x27;Y-m-d h:i:s&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后你可以在模型中实现这个转换</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Models</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Auth</span>\<span class="title">User</span> <span class="title">as</span> <span class="title">Authenticatable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Casts</span>\<span class="title">TimestampsCast</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Carbon</span>\<span class="title">Carbon</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Authenticatable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The attributes that should be cast.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$casts</span> = [</span><br><span class="line">        <span class="string">&#x27;updated_at&#x27;</span> =&gt; TimestampsCast::class,</span><br><span class="line">        <span class="string">&#x27;created_at&#x27;</span> =&gt; TimestampsCast::class,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>NI9NE
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://ni9ne.github.io/2022/11/22/%E6%A1%86%E6%9E%B6/Laravel/Laravel%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-%E6%A8%A1%E5%9E%8B%E4%B8%8EEloquent/" title="Laravel最佳实践-模型与Eloquent">https://ni9ne.github.io/2022/11/22/框架/Laravel/Laravel最佳实践-模型与Eloquent/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E6%A1%86%E6%9E%B6%E5%BC%80%E5%8F%91/" rel="tag"># 框架开发</a>
              <a href="/tags/Laravel/" rel="tag"># Laravel</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/08/22/%E5%AE%89%E5%85%A8/PHP%E7%BC%96%E7%A0%81%E5%AE%89%E5%85%A8%E5%8F%8A%E5%B8%B8%E8%A7%81%E6%94%BB%E5%87%BB/" rel="prev" title="PHP编码安全及常见攻击">
                  <i class="fa fa-chevron-left"></i> PHP编码安全及常见攻击
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/11/22/%E6%A1%86%E6%9E%B6/Laravel/Laravel%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB/" rel="next" title="Laravel最佳实践-数据库迁移">
                  Laravel最佳实践-数据库迁移 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2017 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">NI9NE</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@next-theme/pjax@0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  
<script src="https://unpkg.com/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>


  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
