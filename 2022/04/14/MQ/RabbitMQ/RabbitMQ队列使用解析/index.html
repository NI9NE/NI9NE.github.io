<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)">
<meta name="generator" content="Hexo 5.4.0">

<link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon/safari-pinned-tab.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ni9ne.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.8.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="MQ基本概念MQ概述消息队列(Message Queue), 是在消息的传输过程中保存消息的容器. 多用于分布式系统之间的通信">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMQ队列使用解析">
<meta property="og:url" content="https://ni9ne.github.io/2022/04/14/MQ/RabbitMQ/RabbitMQ%E9%98%9F%E5%88%97%E4%BD%BF%E7%94%A8%E8%A7%A3%E6%9E%90/index.html">
<meta property="og:site_name" content="NI9NE&#39;s Zone">
<meta property="og:description" content="MQ基本概念MQ概述消息队列(Message Queue), 是在消息的传输过程中保存消息的容器. 多用于分布式系统之间的通信">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/82f6bc0251bcc6d488b3637fe694539f-9a5215f.png">
<meta property="og:image" content="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/6cd4495bbd9643344ffd6d82c3349bf3-b3eef98.png">
<meta property="og:image" content="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/1b526643db3fde84ab2eb1e488fb70fe-109d20c.png">
<meta property="og:image" content="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/3238576d5c0748eff5019b39312c3c58-71d7fd9.png">
<meta property="og:image" content="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/2a0607fd9dcbac10144d5239456f3984-5caed21.png">
<meta property="og:image" content="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/01df483bbae06cb709199ff2d468af26-8d59613.png">
<meta property="og:image" content="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/0055dd70094261151ff5f1d589465c43-891eb72.png">
<meta property="og:image" content="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/28f7bbce14ccb147ce51f34991196f77-296e196.png">
<meta property="og:image" content="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/9ba931c87cbe89f6f1994aa9c96ab6d4-5ac1583.png">
<meta property="og:image" content="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/7f8e82711d5de1b66d72caa295d0aba3-ece6edd.png">
<meta property="og:image" content="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/e9ddec7d4142c85ef543ccd566b8ccb2-2d5c9eb.png">
<meta property="og:image" content="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/3753c14a07109806678a2d732c8a93c2-d776b2e.png">
<meta property="og:image" content="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/48e93035a0b9b56a10c3a322efa5527a-565deff.png">
<meta property="og:image" content="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/8400f6d6dca3bfa82e81db7608ab2441-385bb10.png">
<meta property="og:image" content="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/a28075f703394aab53246a0bc4d51633-d0d7ea0.png">
<meta property="og:image" content="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/abf47e01b132a72b26cf044923bd478e-95f15e9.png">
<meta property="og:image" content="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/aee3f04b21ad52736bc5a03b3e6129ed-dbd411f.png">
<meta property="og:image" content="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/1033b16f0ebc170558225fb6407130c7-9444cf8.png">
<meta property="article:published_time" content="2022-04-14T09:58:07.000Z">
<meta property="article:modified_time" content="2022-07-12T11:40:07.374Z">
<meta property="article:author" content="NI9NE">
<meta property="article:tag" content="RabbitMQ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/82f6bc0251bcc6d488b3637fe694539f-9a5215f.png">


<link rel="canonical" href="https://ni9ne.github.io/2022/04/14/MQ/RabbitMQ/RabbitMQ%E9%98%9F%E5%88%97%E4%BD%BF%E7%94%A8%E8%A7%A3%E6%9E%90/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://ni9ne.github.io/2022/04/14/MQ/RabbitMQ/RabbitMQ%E9%98%9F%E5%88%97%E4%BD%BF%E7%94%A8%E8%A7%A3%E6%9E%90/","path":"2022/04/14/MQ/RabbitMQ/RabbitMQ队列使用解析/","title":"RabbitMQ队列使用解析"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>RabbitMQ队列使用解析 | NI9NE's Zone</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">NI9NE's Zone</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">52</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">6</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">106</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#MQ%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">1.</span> <span class="nav-text">MQ基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MQ%E6%A6%82%E8%BF%B0"><span class="nav-number">1.1.</span> <span class="nav-text">MQ概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MQ-%E7%9A%84%E4%BC%98%E5%8A%BF%E5%92%8C%E5%8A%A3%E5%8A%BF"><span class="nav-number">1.2.</span> <span class="nav-text">MQ 的优势和劣势</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MQ-%E7%9A%84%E4%BC%98%E5%8A%BF"><span class="nav-number">1.2.1.</span> <span class="nav-text">MQ 的优势</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MQ-%E7%9A%84%E5%8A%A3%E5%8A%BF"><span class="nav-number">1.2.2.</span> <span class="nav-text">MQ 的劣势</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-MQ-%E9%9C%80%E8%A6%81%E6%BB%A1%E8%B6%B3%E7%9A%84%E6%9D%A1%E4%BB%B6"><span class="nav-number">1.3.</span> <span class="nav-text">使用 MQ 需要满足的条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84-MQ-%E4%BA%A7%E5%93%81"><span class="nav-number">1.4.</span> <span class="nav-text">常见的 MQ 产品</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ-%E7%AE%80%E4%BB%8B"><span class="nav-number">2.</span> <span class="nav-text">RabbitMQ 简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AMQP%E5%8D%8F%E8%AE%AE"><span class="nav-number">2.1.</span> <span class="nav-text">AMQP协议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84"><span class="nav-number">2.2.</span> <span class="nav-text">基础架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="nav-number">2.3.</span> <span class="nav-text">工作模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ-%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE"><span class="nav-number">3.</span> <span class="nav-text">RabbitMQ 的安装和配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ubuntu-18-04%E5%AE%89%E8%A3%85"><span class="nav-number">3.1.</span> <span class="nav-text">ubuntu 18.04安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%90%AF%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2%E5%8F%8A%E9%85%8D%E7%BD%AE"><span class="nav-number">3.2.</span> <span class="nav-text">开启管理界面及配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6"><span class="nav-number">3.3.</span> <span class="nav-text">控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">3.4.</span> <span class="nav-text">配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%99%BB%E9%99%86%E7%AE%A1%E7%90%86%E9%A1%B5%E9%9D%A2"><span class="nav-number">3.5.</span> <span class="nav-text">登陆管理页面</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="nav-number">4.</span> <span class="nav-text">RabbitMQ 快速入门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#window-wamp%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">4.1.</span> <span class="nav-text">window_wamp开发环境搭建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B"><span class="nav-number">4.2.</span> <span class="nav-text">测试用例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ-%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.</span> <span class="nav-text">RabbitMQ 的工作模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Work-queues-%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.1.</span> <span class="nav-text">Work queues 工作队列模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pub-Sub-%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.2.</span> <span class="nav-text">Pub&#x2F;Sub 订阅模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Routing-%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.3.</span> <span class="nav-text">Routing 路由模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Topics-%E9%80%9A%E9%85%8D%E7%AC%A6%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.4.</span> <span class="nav-text">Topics 通配符模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93"><span class="nav-number">5.5.</span> <span class="nav-text">工作模式总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7"><span class="nav-number">6.</span> <span class="nav-text">高级特性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%8A%95%E9%80%92"><span class="nav-number">6.1.</span> <span class="nav-text">消息可靠性投递</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Consumer-ACK"><span class="nav-number">6.2.</span> <span class="nav-text">Consumer ACK</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E8%B4%B9%E7%AB%AF%E9%99%90%E6%B5%81"><span class="nav-number">6.3.</span> <span class="nav-text">消费端限流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TTL"><span class="nav-number">6.4.</span> <span class="nav-text">TTL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="nav-number">6.5.</span> <span class="nav-text">死信队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97"><span class="nav-number">6.6.</span> <span class="nav-text">延迟队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E4%B8%8E%E7%9B%91%E6%8E%A7"><span class="nav-number">6.7.</span> <span class="nav-text">日志与监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E8%BF%BD%E8%B8%AA"><span class="nav-number">6.8.</span> <span class="nav-text">消息追踪</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="NI9NE"
      src="/images/favicon/mstile-150x150.png">
  <p class="site-author-name" itemprop="name">NI9NE</p>
  <div class="site-description" itemprop="description">TECH OTAKU SAVE THE WORLD</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">106</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">52</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ni9ne" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ni9ne" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://gitee.com/ni9ne" title="Gitee → https:&#x2F;&#x2F;gitee.com&#x2F;ni9ne" rel="noopener" target="_blank"><i class="fab fa-git fa-fw"></i>Gitee</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://unpkg.com/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://gitee.com/ni9ne" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ni9ne.github.io/2022/04/14/MQ/RabbitMQ/RabbitMQ%E9%98%9F%E5%88%97%E4%BD%BF%E7%94%A8%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon/mstile-150x150.png">
      <meta itemprop="name" content="NI9NE">
      <meta itemprop="description" content="TECH OTAKU SAVE THE WORLD">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NI9NE's Zone">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          RabbitMQ队列使用解析
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-14 17:58:07" itemprop="dateCreated datePublished" datetime="2022-04-14T17:58:07+08:00">2022-04-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91%E8%B5%84%E6%96%99/" itemprop="url" rel="index"><span itemprop="name">开发资料</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="MQ基本概念"><a href="#MQ基本概念" class="headerlink" title="MQ基本概念"></a>MQ基本概念</h2><h3 id="MQ概述"><a href="#MQ概述" class="headerlink" title="MQ概述"></a>MQ概述</h3><p><strong>消息队列(Message Queue)</strong>, 是在消息的传输过程中保存消息的容器. 多用于分布式系统之间的通信</p>
<p><img src="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/82f6bc0251bcc6d488b3637fe694539f-9a5215f.png" alt="image-20220709125842485"></p>
<p>发送方称为<strong>生产者</strong>，接收方称为<strong>消费者</strong> </p>
<p>分布式系统通信两种方式：直接远程调用 和 借助第三方 完成间接通信</p>
<h3 id="MQ-的优势和劣势"><a href="#MQ-的优势和劣势" class="headerlink" title="MQ 的优势和劣势"></a>MQ 的优势和劣势</h3><h4 id="MQ-的优势"><a href="#MQ-的优势" class="headerlink" title="MQ 的优势"></a>MQ 的优势</h4><ul>
<li><p><strong>应用解耦</strong></p>
<p>系统的耦合性越高，容错性就越低，可维护性就越低。</p>
<p>使用 MQ 使得应用间解耦，提升容错性和可维护性。</p>
</li>
<li><p><strong>异步提速</strong></p>
<p>提升用户体验和系统吞吐量（单位时间内处理请求的数目）。</p>
<p><img src="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/6cd4495bbd9643344ffd6d82c3349bf3-b3eef98.png" alt="image-20220709130316032"></p>
</li>
<li><p><strong>削峰填谷</strong></p>
<p><img src="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/1b526643db3fde84ab2eb1e488fb70fe-109d20c.png" alt="image-20220709130427441"></p>
<p>使用了 MQ 之后，限制消费消息的速度为1000，这样一来，高峰期产生的数据势必会被积压在 MQ 中，高峰就被“削”掉了.</p>
<p>但是因为消息积压，在高峰期过后的一段时间内，消费消息的速度还是会维持在1000，直到消费完积压的消息，这就叫做“填谷”。</p>
</li>
</ul>
<h4 id="MQ-的劣势"><a href="#MQ-的劣势" class="headerlink" title="MQ 的劣势"></a>MQ 的劣势</h4><p><img src="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/3238576d5c0748eff5019b39312c3c58-71d7fd9.png" alt="image-20220709130614372"></p>
<ul>
<li><p><strong>系统可用性降低</strong></p>
<p>系统引入的外部依赖越多，系统稳定性越差。一旦 MQ 宕机，就会对业务造成影响。如何保证MQ的高可用？</p>
</li>
<li><p> <strong>系统复杂度提高</strong></p>
</li>
</ul>
<p>  MQ 的加入大大增加了系统的复杂度，以前系统间是同步的远程调用，现在是通过 MQ 进行异步调用。如何保证消息没有被重复消费？怎么处理消息丢失情况？那么保证消息传递的顺序性？</p>
<ul>
<li><p><strong>一致性问题</strong></p>
<p>A 系统处理完业务，通过 MQ 给B、C、D三个系统发消息数据，如果 B 系统、C 系统处理成功，D 系统处理失败。如何保证消息数据处理的一致性？</p>
</li>
</ul>
<h3 id="使用-MQ-需要满足的条件"><a href="#使用-MQ-需要满足的条件" class="headerlink" title="使用 MQ 需要满足的条件"></a>使用 MQ 需要满足的条件</h3><ul>
<li>生产者不需要从消费者处获得反馈。引入消息队列之前的直接调用，其接口的返回值应该为空，这才让明明下层的动作还没做，上层却当成动作做完了继续往后走，即所谓异步成为了可能。</li>
<li>容许短暂的不一致性。</li>
<li>确实是用了有效果。即解耦、提速、削峰这些方面的收益，超过加入MQ，管理MQ这些成本。</li>
</ul>
<h3 id="常见的-MQ-产品"><a href="#常见的-MQ-产品" class="headerlink" title="常见的 MQ 产品"></a>常见的 MQ 产品</h3><table>
<thead>
<tr>
<th></th>
<th>RabbitMQ</th>
<th>ActiveMQ</th>
<th>RocketMQ</th>
<th>Kafka</th>
</tr>
</thead>
<tbody><tr>
<td>公司/社区</td>
<td>Rabbit</td>
<td>Apache</td>
<td>阿里</td>
<td>Apache</td>
</tr>
<tr>
<td>开发语言</td>
<td>Erlang</td>
<td>Java</td>
<td>Java</td>
<td>Scala&amp;Java</td>
</tr>
<tr>
<td>协议支持</td>
<td>AMQP，XMPP，SMTP， STOMP</td>
<td>OpenWire,STOMP， REST,XMPP,AMQP</td>
<td>自定义</td>
<td>自定义协议，社区封装了http协议支持</td>
</tr>
<tr>
<td>客户端支持语言</td>
<td>官方支持Erlang，Java，  Ruby等,社区产出多种API，几乎支持所有语言</td>
<td>Java，C，C++，  Python，PHP，  Perl，.net等</td>
<td>Java，C++（不成熟</td>
<td>官方支持Java,社区产出  多种API，如PHP，  Python等</td>
</tr>
</tbody></table>
<h2 id="RabbitMQ-简介"><a href="#RabbitMQ-简介" class="headerlink" title="RabbitMQ 简介"></a>RabbitMQ 简介</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">官网: https://www.rabbitmq.com</span><br></pre></td></tr></table></figure>

<h3 id="AMQP协议"><a href="#AMQP协议" class="headerlink" title="AMQP协议"></a>AMQP协议</h3><p><strong>AMQP</strong>，即 <strong>Advanced Message Queuing Protocol</strong>（高级消息队列协议），是一个<strong>网络协议</strong>，是应用层协议的一个开放标准，为面向消息的中间件设计。基于此协议的客户端与消息中间件可传递消息，并不受客户端/中间件不同产品，不同的开发语言等条件的限制。2006年，AMQP 规范发布。类比HTTP。</p>
<h3 id="基础架构"><a href="#基础架构" class="headerlink" title="基础架构"></a>基础架构</h3><p>2007年，Rabbit 技术公司基于 AMQP 标准开发的 RabbitMQ 1.0 发布。RabbitMQ 采用 Erlang 语言开发。<br>Erlang 语言由 Ericson 设计，专门为开发高并发和分布式系统的一种语言，在电信领域使用广泛。</p>
<p>RabbitMQ 基础架构如下图：</p>
<p><img src="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/2a0607fd9dcbac10144d5239456f3984-5caed21.png" alt="image-20220709131308174"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">相关概念：</span><br><span class="line">- Broker：接收和分发消息的应用，RabbitMQ Server就是 Message Broker</span><br><span class="line"></span><br><span class="line">- Virtual host：出于多租户和安全因素设计的，把 AMQP 的基本组件划分到一个虚拟的分组中，类似于网络中的 namespace 概念。当多个不同的用户使用同一个 RabbitMQ server 提供的服务时，可以划分出多个vhost，每个用户在自己的 vhost 创建 exchange／queue 等</span><br><span class="line"></span><br><span class="line">- Connection：publisher／consumer 和 broker 之间的 TCP 连接</span><br><span class="line"></span><br><span class="line">- Channel：如果每一次访问 RabbitMQ 都建立一个 Connection，在消息量大的时候建立 TCP Connection的开销将是巨大的，效率也较低。Channel 是在 connection 内部建立的逻辑连接，如果应用程序支持多线程，通常每个thread创建单独的 channel 进行通讯，AMQP method 包含了channel id 帮助客户端和message broker 识别 channel，所以 channel 之间是完全隔离的。Channel 作为轻量级的 Connection极大减少了操作系统建立 TCP connection 的开销</span><br><span class="line"></span><br><span class="line">- Exchange：message 到达 broker 的第一站，根据分发规则，匹配查询表中的 routing key，分发消息到queue 中去。常用的类型有：direct (point-to-point), topic (publish-subscribe) and fanout (multicast)</span><br><span class="line"></span><br><span class="line">- Queue：消息最终被送到这里等待 consumer 取走</span><br><span class="line"></span><br><span class="line">- Binding：exchange 和 queue 之间的虚拟连接，binding 中可以包含 routing key。Binding 信息被保存到 exchange 中的查询表中，用于 message 的分发依据</span><br></pre></td></tr></table></figure>

<h3 id="工作模式"><a href="#工作模式" class="headerlink" title="工作模式"></a>工作模式</h3><p>RabbitMQ 提供了 <strong>6 种工作模式</strong>：</p>
<p>简单模式、work queues、Publish/Subscribe 发布与订阅模式、Routing路由模式、Topics 主题模式、RPC 远程调用模式（远程调用，不太算 MQ；暂不作介绍）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">官网对应模式介绍：https://www.rabbitmq.com/getstarted.html</span><br></pre></td></tr></table></figure>

<p><img src="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/01df483bbae06cb709199ff2d468af26-8d59613.png" alt="image-20220709131840455"></p>
<h2 id="RabbitMQ-的安装和配置"><a href="#RabbitMQ-的安装和配置" class="headerlink" title="RabbitMQ 的安装和配置"></a>RabbitMQ 的安装和配置</h2><h3 id="ubuntu-18-04安装"><a href="#ubuntu-18-04安装" class="headerlink" title="ubuntu 18.04安装"></a>ubuntu 18.04安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/usr/bin/sh</span></span><br><span class="line"></span><br><span class="line">sudo apt-get install curl gnupg apt-transport-https -y</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Team RabbitMQ&#x27;s main signing key</span></span></span><br><span class="line">curl -1sLf &quot;https://keys.openpgp.org/vks/v1/by-fingerprint/0A9AF2115F4687BD29803A206B73A36E6026DFCA&quot; | sudo gpg --dearmor | sudo tee /usr/share/keyrings/com.rabbitmq.team.gpg &gt; /dev/null</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Launchpad PPA that provides modern Erlang releases</span></span></span><br><span class="line">curl -1sLf &quot;https://keyserver.ubuntu.com/pks/lookup?op=get&amp;search=0xf77f1eda57ebb1cc&quot; | sudo gpg --dearmor | sudo tee /usr/share/keyrings/net.launchpad.ppa.rabbitmq.erlang.gpg &gt; /dev/null</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># PackageCloud RabbitMQ repository</span></span></span><br><span class="line">curl -1sLf &quot;https://packagecloud.io/rabbitmq/rabbitmq-server/gpgkey&quot; | sudo gpg --dearmor | sudo tee /usr/share/keyrings/io.packagecloud.rabbitmq.gpg &gt; /dev/null</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Add apt repositories maintained by Team RabbitMQ</span></span></span><br><span class="line">sudo tee /etc/apt/sources.list.d/rabbitmq.list &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Provides modern Erlang/OTP releases</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># &quot;bionic&quot; as distribution name should work for any reasonably recent Ubuntu or Debian release.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># See the release to distribution mapping table in RabbitMQ doc guides to learn more.</span></span></span><br><span class="line">deb [signed-by=/usr/share/keyrings/net.launchpad.ppa.rabbitmq.erlang.gpg] http://ppa.launchpad.net/rabbitmq/rabbitmq-erlang/ubuntu bionic main</span><br><span class="line">deb-src [signed-by=/usr/share/keyrings/net.launchpad.ppa.rabbitmq.erlang.gpg] http://ppa.launchpad.net/rabbitmq/rabbitmq-erlang/ubuntu bionic main</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Provides RabbitMQ</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># &quot;bionic&quot; as distribution name should work for any reasonably recent Ubuntu or Debian release.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># See the release to distribution mapping table in RabbitMQ doc guides to learn more.</span></span></span><br><span class="line">deb [signed-by=/usr/share/keyrings/io.packagecloud.rabbitmq.gpg] https://packagecloud.io/rabbitmq/rabbitmq-server/ubuntu/ bionic main</span><br><span class="line">deb-src [signed-by=/usr/share/keyrings/io.packagecloud.rabbitmq.gpg] https://packagecloud.io/rabbitmq/rabbitmq-server/ubuntu/ bionic main</span><br><span class="line">EOF</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Update package indices</span></span></span><br><span class="line">sudo apt-get update -y</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Install Erlang packages</span></span></span><br><span class="line">sudo apt-get install -y erlang-base \</span><br><span class="line">                        erlang-asn1 erlang-crypto erlang-eldap erlang-ftp erlang-inets \</span><br><span class="line">                        erlang-mnesia erlang-os-mon erlang-parsetools erlang-public-key \</span><br><span class="line">                        erlang-runtime-tools erlang-snmp erlang-ssl \</span><br><span class="line">                        erlang-syntax-tools erlang-tftp erlang-tools erlang-xmerl</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Install rabbitmq-server and its dependencies</span></span></span><br><span class="line">sudo apt-get install rabbitmq-server -y --fix-missing</span><br></pre></td></tr></table></figure>

<p>下面是应该与  RabbitMQ apt 存储库一起使用的操作系统版本和分发名称表</p>
<table>
<thead>
<tr>
<th align="left">Release</th>
<th align="left">Distribution</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Ubuntu 20.04</td>
<td align="left"><code>focal</code></td>
</tr>
<tr>
<td align="left">Ubuntu 18.04</td>
<td align="left"><code>bionic</code></td>
</tr>
<tr>
<td align="left">Debian Buster</td>
<td align="left"><code>buster</code></td>
</tr>
<tr>
<td align="left">Debian Bullseye</td>
<td align="left"><code>bullseye</code></td>
</tr>
<tr>
<td align="left">Debian Sid</td>
<td align="left"><code>bullseye</code></td>
</tr>
</tbody></table>
<h3 id="开启管理界面及配置"><a href="#开启管理界面及配置" class="headerlink" title="开启管理界面及配置"></a>开启管理界面及配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 开启管理界面</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改默认配置信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo vim /usr/lib/rabbitmq/lib/rabbitmq_server-3.6.5/ebin/rabbit.app</span> </span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo vim /usr/lib/rabbitmq/lib/rabbitmq_server-3.10.5/plugins/rabbit-3.10.5/ebin/rabbit.app</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 比如修改密码、配置等等，例如：loopback_users 中的 &lt;&lt;<span class="string">&quot;guest&quot;</span>&gt;&gt;,只保留guest</span></span><br></pre></td></tr></table></figure>

<h3 id="控制"><a href="#控制" class="headerlink" title="控制"></a>控制</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service rabbitmq-server start # 启动服务</span><br><span class="line">service rabbitmq-server stop # 停止服务</span><br><span class="line">service rabbitmq-server restart # 重启服务</span><br></pre></td></tr></table></figure>

<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cp /usr/share/doc/rabbitmq-server-3.6.5/rabbitmq.config.example /etc/rabbitmq/rabbitmq.config</span></span><br></pre></td></tr></table></figure>

<h3 id="登陆管理页面"><a href="#登陆管理页面" class="headerlink" title="登陆管理页面"></a>登陆管理页面</h3><blockquote>
<p>默认账密: guest   guest</p>
</blockquote>
<p><img src="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/0055dd70094261151ff5f1d589465c43-891eb72.png" alt="image-20220709152518724"></p>
<h2 id="RabbitMQ-快速入门"><a href="#RabbitMQ-快速入门" class="headerlink" title="RabbitMQ 快速入门"></a>RabbitMQ 快速入门</h2><h3 id="window-wamp开发环境搭建"><a href="#window-wamp开发环境搭建" class="headerlink" title="window_wamp开发环境搭建"></a>window_wamp开发环境搭建</h3><ul>
<li><p><strong>下载扩展</strong></p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://pecl.php.net/package/amqp</span><br></pre></td></tr></table></figure></li>
<li><p><strong>移动扩展文件</strong></p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">复制文件 php_amqp.dll + php_amqp.pdb 到 D:\wamp64\bin\php\php7.3.21\ext\</span><br><span class="line">复制文件 rabbitmq.4.dll + rabbitmq.4.pdb  到 D:\wamp64\bin\php\php7.3.21</span><br></pre></td></tr></table></figure></li>
<li><p><strong>修改配置文件</strong></p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">D:\wamp64\bin\php\php7.3.21\phpForApache.ini</span><br><span class="line">添加行 : extension=php_amqp.dll</span><br><span class="line"></span><br><span class="line">D:\wamp64\bin\apache\apache2.4.46\conf\httpd.conf</span><br><span class="line">添加行: LoadFile &quot;D:/wamp64/bin/php/php7.3.21/rabbitmq.4.dll&quot;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>重启服务</strong></p>
<p><img src="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/28f7bbce14ccb147ce51f34991196f77-296e196.png" alt="image-20220709154449199"></p>
</li>
</ul>
<h3 id="测试用例"><a href="#测试用例" class="headerlink" title="测试用例"></a>测试用例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">官方文档: 使用php-amqplib/php-amqplib</span><br><span class="line">https://www.rabbitmq.com/tutorials/tutorial-one-php.html</span><br><span class="line">https://github.com/php-amqplib/php-amqplib/tree/master/demo</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment"># producer.php</span></span><br><span class="line"><span class="variable">$conn_args</span> = [</span><br><span class="line">    <span class="string">&#x27;host&#x27;</span> =&gt; <span class="string">&#x27;192.168.253.141&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;port&#x27;</span> =&gt; <span class="number">5672</span>,</span><br><span class="line">    <span class="string">&#x27;login&#x27;</span> =&gt; <span class="string">&#x27;ni9ne&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;password&#x27;</span> =&gt; <span class="string">&#x27;ni9ne&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;vhost&#x27;</span> =&gt; <span class="string">&#x27;/ni9ne&#x27;</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="variable">$conn</span> = <span class="keyword">new</span> AMQPConnection(<span class="variable">$conn_args</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$conn</span>-&gt;connect()) <span class="keyword">die</span>(<span class="string">&#x27;failed to connect to AMQP&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (AMQPConnectionException <span class="variable">$e</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="variable">$e</span>-&gt;getMessage());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$exchange_name</span> = <span class="string">&#x27;e_ni9ne&#x27;</span>;</span><br><span class="line"><span class="comment">// $queue_name = &#x27;q_ni9ne&#x27;;</span></span><br><span class="line"><span class="variable">$route_key</span> = <span class="string">&#x27;key_1&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span> = <span class="keyword">new</span> AMQPChannel(<span class="variable">$conn</span>);</span><br><span class="line"><span class="comment">// 创建交换机</span></span><br><span class="line"><span class="variable">$exchange</span> = <span class="keyword">new</span> AMQPExchange(<span class="variable">$channel</span>);</span><br><span class="line"><span class="variable">$exchange</span>-&gt;setName(<span class="variable">$exchange_name</span>);</span><br><span class="line">date_default_timezone_set(<span class="string">&#x27;Asia/Shanghai&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">100</span>; <span class="variable">$i</span> ++)&#123;</span><br><span class="line">    usleep(<span class="number">100</span>);</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&quot;This is A Message From Producer!&quot;</span> . date(<span class="string">&quot;H:i:s&quot;</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$exchange</span>-&gt;publish(<span class="variable">$msg</span>, <span class="variable">$route_key</span>);</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">&quot;Publish Message: &quot;</span>. <span class="variable">$result</span>. <span class="string">&#x27;; time: &#x27;</span> . <span class="variable">$i</span>);</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">&#x27;&lt;br/&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$conn</span>-&gt;disconnect();</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment"># consumer.php</span></span><br><span class="line"><span class="variable">$conn_args</span> = [</span><br><span class="line">    <span class="string">&#x27;host&#x27;</span> =&gt; <span class="string">&#x27;192.168.253.141&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;port&#x27;</span> =&gt; <span class="number">5672</span>,</span><br><span class="line">    <span class="string">&#x27;login&#x27;</span> =&gt; <span class="string">&#x27;ni9ne&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;password&#x27;</span> =&gt; <span class="string">&#x27;ni9ne&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;vhost&#x27;</span> =&gt; <span class="string">&#x27;/ni9ne&#x27;</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="variable">$conn</span> = <span class="keyword">new</span> AMQPConnection(<span class="variable">$conn_args</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$conn</span>-&gt;connect()) <span class="keyword">die</span>(<span class="string">&#x27;failed to connect to AMQP&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (AMQPConnectionException <span class="variable">$e</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="variable">$e</span>-&gt;getMessage());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$exchange_name</span> = <span class="string">&#x27;e_ni9ne&#x27;</span>;</span><br><span class="line"><span class="variable">$queue_name</span> = <span class="string">&#x27;q_ni9ne&#x27;</span>;</span><br><span class="line"><span class="variable">$route_key</span> = <span class="string">&#x27;key_1&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span> = <span class="keyword">new</span> AMQPChannel(<span class="variable">$conn</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建交换机</span></span><br><span class="line"><span class="variable">$exchange</span> = <span class="keyword">new</span> AMQPExchange(<span class="variable">$channel</span>);</span><br><span class="line"><span class="variable">$exchange</span>-&gt;setName(<span class="variable">$exchange_name</span>);</span><br><span class="line"><span class="variable">$exchange</span>-&gt;setType(AMQP_EX_TYPE_DIRECT);</span><br><span class="line"><span class="variable">$exchange</span>-&gt;setFlags(AMQP_DURABLE);</span><br><span class="line"><span class="keyword">print</span>(<span class="string">&quot;Exchange Status: &quot;</span> . <span class="variable">$exchange</span>-&gt;declareExchange());</span><br><span class="line"><span class="keyword">print</span>(<span class="string">&#x27;&lt;br/&gt;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建队列</span></span><br><span class="line"><span class="variable">$queue</span> = <span class="keyword">new</span> AMQPQueue(<span class="variable">$channel</span>);</span><br><span class="line"><span class="variable">$queue</span>-&gt;setName(<span class="variable">$queue_name</span>);</span><br><span class="line"><span class="variable">$queue</span>-&gt;setFlags(AMQP_DURABLE);</span><br><span class="line"><span class="keyword">print</span>(<span class="string">&quot;Queue Message Total: &quot;</span> . <span class="variable">$queue</span>-&gt;declareQueue());</span><br><span class="line"><span class="keyword">print</span>(<span class="string">&#x27;&lt;br/&gt;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定交换机与队列, 并指定路由键</span></span><br><span class="line"><span class="variable">$bind</span> = <span class="variable">$queue</span>-&gt;bind(<span class="variable">$exchange_name</span>, <span class="variable">$route_key</span>);</span><br><span class="line"><span class="keyword">print</span>(<span class="string">&quot;Queue Bind: &quot;</span>. <span class="variable">$bind</span>);</span><br><span class="line"><span class="keyword">print</span>(<span class="string">&#x27;&lt;br/&gt;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 阻塞模式接收消息处理</span></span><br><span class="line"><span class="keyword">print</span>(<span class="string">&quot;Messages: &quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$queue</span>-&gt;consume(<span class="string">&#x27;handleMessage&#x27;</span>);</span><br><span class="line"><span class="comment"># 自动应答</span></span><br><span class="line"><span class="comment"># $queue-&gt;consume(&#x27;handleMessage&#x27;,AMQP_AUTOACK);</span></span><br><span class="line"><span class="variable">$conn</span>-&gt;disconnect();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleMessage</span>(<span class="params">AMQPEnvelope <span class="variable">$envelope</span>, AMQPQueue <span class="variable">$queue</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="variable">$envelope</span>-&gt;getBody();</span><br><span class="line">    <span class="keyword">print</span>(<span class="variable">$msg</span>);</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">&#x27;&lt;br/&gt;&#x27;</span>);</span><br><span class="line">    file_put_contents(<span class="string">&#x27;msg.txt&#x27;</span>, <span class="string">&quot;消息体: &quot;</span> . <span class="variable">$msg</span> . PHP_EOL, FILE_APPEND);</span><br><span class="line">    <span class="variable">$queue</span>-&gt;ack(<span class="variable">$envelope</span>-&gt;getDeliveryTag());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/9ba931c87cbe89f6f1994aa9c96ab6d4-5ac1583.png" alt="image-20220712082828313"></p>
<h2 id="RabbitMQ-的工作模式"><a href="#RabbitMQ-的工作模式" class="headerlink" title="RabbitMQ 的工作模式"></a>RabbitMQ 的工作模式</h2><h3 id="Work-queues-工作队列模式"><a href="#Work-queues-工作队列模式" class="headerlink" title="Work queues 工作队列模式"></a>Work queues 工作队列模式</h3><p><img src="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/7f8e82711d5de1b66d72caa295d0aba3-ece6edd.png" alt="image-20220712095617691"></p>
<p>支持多个消费者, 共同消费同一个队列中的消息。对于任务过重或任务较多情况使用工作队列可以提高任务处理的速度。</p>
<p>在一个队列中如果有多个消费者，那么消费者之间对于同一个消息的关系是竞争的关系。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment"># worker.php 生产者</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/vendor/autoload.php&#x27;</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$connection</span> = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">5672</span>, <span class="string">&#x27;guest&#x27;</span>, <span class="string">&#x27;guest&#x27;</span>);</span><br><span class="line"><span class="variable">$channel</span> = <span class="variable">$connection</span>-&gt;channel();</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;queue_declare(<span class="string">&#x27;task_queue&#x27;</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot; [*] Waiting for messages. To exit press CTRL+C\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$callback</span> = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$msg</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27; [x] Received &#x27;</span>, <span class="variable">$msg</span>-&gt;body, <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    sleep(substr_count(<span class="variable">$msg</span>-&gt;body, <span class="string">&#x27;.&#x27;</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot; [x] Done\n&quot;</span>;</span><br><span class="line">    <span class="variable">$msg</span>-&gt;ack();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;basic_qos(<span class="literal">null</span>, <span class="number">1</span>, <span class="literal">null</span>);</span><br><span class="line"><span class="variable">$channel</span>-&gt;basic_consume(<span class="string">&#x27;task_queue&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="variable">$callback</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="variable">$channel</span>-&gt;is_open()) &#123;</span><br><span class="line">    <span class="variable">$channel</span>-&gt;wait();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;close();</span><br><span class="line"><span class="variable">$connection</span>-&gt;close();</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment"># new_task.php 消费者</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/vendor/autoload.php&#x27;</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Message</span>\<span class="title">AMQPMessage</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$connection</span> = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">5672</span>, <span class="string">&#x27;guest&#x27;</span>, <span class="string">&#x27;guest&#x27;</span>);</span><br><span class="line"><span class="variable">$channel</span> = <span class="variable">$connection</span>-&gt;channel();</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;queue_declare(<span class="string">&#x27;task_queue&#x27;</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$data</span> = implode(<span class="string">&#x27; &#x27;</span>, array_slice(<span class="variable">$argv</span>, <span class="number">1</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">    <span class="variable">$data</span> = <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$msg</span> = <span class="keyword">new</span> AMQPMessage(</span><br><span class="line">    <span class="variable">$data</span>,</span><br><span class="line">    <span class="keyword">array</span>(<span class="string">&#x27;delivery_mode&#x27;</span> =&gt; AMQPMessage::DELIVERY_MODE_PERSISTENT)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;basic_publish(<span class="variable">$msg</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;task_queue&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27; [x] Sent &#x27;</span>, <span class="variable">$data</span>, <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;close();</span><br><span class="line"><span class="variable">$connection</span>-&gt;close();</span><br></pre></td></tr></table></figure>

<h3 id="Pub-Sub-订阅模式"><a href="#Pub-Sub-订阅模式" class="headerlink" title="Pub/Sub 订阅模式"></a>Pub/Sub 订阅模式</h3><p><img src="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/e9ddec7d4142c85ef543ccd566b8ccb2-2d5c9eb.png" alt="image-20220712100007813"></p>
<p>在订阅模型中，多了一个 Exchange 角色，而且过程略有变化：</p>
<ul>
<li><p>P：生产者，也就是要发送消息的程序，但是不再发送到队列中，而是发给X（交换机）</p>
</li>
<li><p>C：消费者，消息的接收者，会一直等待消息到来</p>
</li>
<li><p>Queue：消息队列，接收消息、缓存消息</p>
</li>
<li><p>Exchange：交换机（X）。一方面，接收生产者发送的消息。另一方面，指导如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。如何操作，取决于Exchange的类型。</p>
</li>
</ul>
<p><strong>Exchange有常见以下3种类型</strong>：</p>
<ul>
<li><strong>Fanout</strong>：广播，将消息交给所有绑定到交换机的队列</li>
<li><strong>Direct</strong>：定向，把消息交给符合指定routing key 的队列</li>
<li><strong>Topic</strong>：通配符，把消息交给符合routing pattern（路由模式） 的队列</li>
</ul>
<p>Exchange（交换机）只负责转发消息，不具备存储消息的能力，因此如果没有任何队列Queue与 Exchange 绑定，或者没有符合路由规则的队列，那么消息会丢失</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment"># emit_log.php 生产者</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/vendor/autoload.php&#x27;</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Message</span>\<span class="title">AMQPMessage</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$connection</span> = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">5672</span>, <span class="string">&#x27;guest&#x27;</span>, <span class="string">&#x27;guest&#x27;</span>);</span><br><span class="line"><span class="variable">$channel</span> = <span class="variable">$connection</span>-&gt;channel();</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;exchange_declare(<span class="string">&#x27;logs&#x27;</span>, <span class="string">&#x27;fanout&#x27;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$data</span> = implode(<span class="string">&#x27; &#x27;</span>, array_slice(<span class="variable">$argv</span>, <span class="number">1</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">    <span class="variable">$data</span> = <span class="string">&quot;info: Hello World!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$msg</span> = <span class="keyword">new</span> AMQPMessage(<span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;basic_publish(<span class="variable">$msg</span>, <span class="string">&#x27;logs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27; [x] Sent &#x27;</span>, <span class="variable">$data</span>, <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;close();</span><br><span class="line"><span class="variable">$connection</span>-&gt;close();</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment"># receive_logs.php 消费者</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/vendor/autoload.php&#x27;</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$connection</span> = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">5672</span>, <span class="string">&#x27;guest&#x27;</span>, <span class="string">&#x27;guest&#x27;</span>);</span><br><span class="line"><span class="variable">$channel</span> = <span class="variable">$connection</span>-&gt;channel();</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;exchange_declare(<span class="string">&#x27;logs&#x27;</span>, <span class="string">&#x27;fanout&#x27;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">list</span>(<span class="variable">$queue_name</span>, ,) = <span class="variable">$channel</span>-&gt;queue_declare(<span class="string">&quot;&quot;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;queue_bind(<span class="variable">$queue_name</span>, <span class="string">&#x27;logs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot; [*] Waiting for logs. To exit press CTRL+C\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$callback</span> = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$msg</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27; [x] &#x27;</span>, <span class="variable">$msg</span>-&gt;body, <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;basic_consume(<span class="variable">$queue_name</span>, <span class="string">&#x27;&#x27;</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="variable">$callback</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="variable">$channel</span>-&gt;is_open()) &#123;</span><br><span class="line">    <span class="variable">$channel</span>-&gt;wait();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;close();</span><br><span class="line"><span class="variable">$connection</span>-&gt;close();</span><br></pre></td></tr></table></figure>

<h3 id="Routing-路由模式"><a href="#Routing-路由模式" class="headerlink" title="Routing 路由模式"></a>Routing 路由模式</h3><ul>
<li>队列与交换机的绑定，不是任意绑定，而是要指定一个 RoutingKey（路由key）</li>
<li>消息的发送方在向 Exchange 发送消息时，也必须指定消息的 RoutingKey</li>
<li>Exchange 不再把消息交给每一个绑定的队列，而是根据消息的 Routing Key 进行判断，只有队列的Routingkey 与消息的 Routing key 完全一致，才会接收到消息</li>
</ul>
<p><img src="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/3753c14a07109806678a2d732c8a93c2-d776b2e.png" alt="image-20220712105401217"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">P：生产者，向 Exchange 发送消息，发送消息时，会指定一个routing key</span><br><span class="line">X：Exchange（交换机），接收生产者的消息，然后把消息递交给与 routing key 完全匹配的队列</span><br><span class="line">C1：消费者，其所在队列指定了需要 routing key 为 error 的消息</span><br><span class="line">C2：消费者，其所在队列指定了需要 routing key 为 info、error、warning 的消息</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment"># emit_log_direct.php 生产者</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/vendor/autoload.php&#x27;</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Message</span>\<span class="title">AMQPMessage</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$connection</span> = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">5672</span>, <span class="string">&#x27;guest&#x27;</span>, <span class="string">&#x27;guest&#x27;</span>);</span><br><span class="line"><span class="variable">$channel</span> = <span class="variable">$connection</span>-&gt;channel();</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;exchange_declare(<span class="string">&#x27;direct_logs&#x27;</span>, <span class="string">&#x27;direct&#x27;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$severity</span> = <span class="keyword">isset</span>(<span class="variable">$argv</span>[<span class="number">1</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$argv</span>[<span class="number">1</span>]) ? <span class="variable">$argv</span>[<span class="number">1</span>] : <span class="string">&#x27;info&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$data</span> = implode(<span class="string">&#x27; &#x27;</span>, array_slice(<span class="variable">$argv</span>, <span class="number">2</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">    <span class="variable">$data</span> = <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$msg</span> = <span class="keyword">new</span> AMQPMessage(<span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;basic_publish(<span class="variable">$msg</span>, <span class="string">&#x27;direct_logs&#x27;</span>, <span class="variable">$severity</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27; [x] Sent &#x27;</span>, <span class="variable">$severity</span>, <span class="string">&#x27;:&#x27;</span>, <span class="variable">$data</span>, <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;close();</span><br><span class="line"><span class="variable">$connection</span>-&gt;close();</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment"># receive_logs_direct.php 消费者</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/vendor/autoload.php&#x27;</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$connection</span> = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">5672</span>, <span class="string">&#x27;guest&#x27;</span>, <span class="string">&#x27;guest&#x27;</span>);</span><br><span class="line"><span class="variable">$channel</span> = <span class="variable">$connection</span>-&gt;channel();</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;exchange_declare(<span class="string">&#x27;direct_logs&#x27;</span>, <span class="string">&#x27;direct&#x27;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">list</span>(<span class="variable">$queue_name</span>, ,) = <span class="variable">$channel</span>-&gt;queue_declare(<span class="string">&quot;&quot;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$severities</span> = array_slice(<span class="variable">$argv</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$severities</span>)) &#123;</span><br><span class="line">    file_put_contents(<span class="string">&#x27;php://stderr&#x27;</span>, <span class="string">&quot;Usage: <span class="subst">$argv</span>[0] [info] [warning] [error]\n&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$severities</span> <span class="keyword">as</span> <span class="variable">$severity</span>) &#123;</span><br><span class="line">    <span class="variable">$channel</span>-&gt;queue_bind(<span class="variable">$queue_name</span>, <span class="string">&#x27;direct_logs&#x27;</span>, <span class="variable">$severity</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot; [*] Waiting for logs. To exit press CTRL+C\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$callback</span> = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$msg</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27; [x] &#x27;</span>, <span class="variable">$msg</span>-&gt;delivery_info[<span class="string">&#x27;routing_key&#x27;</span>], <span class="string">&#x27;:&#x27;</span>, <span class="variable">$msg</span>-&gt;body, <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;basic_consume(<span class="variable">$queue_name</span>, <span class="string">&#x27;&#x27;</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="variable">$callback</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="variable">$channel</span>-&gt;is_open()) &#123;</span><br><span class="line">    <span class="variable">$channel</span>-&gt;wait();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;close();</span><br><span class="line"><span class="variable">$connection</span>-&gt;close();</span><br></pre></td></tr></table></figure>

<h3 id="Topics-通配符模式"><a href="#Topics-通配符模式" class="headerlink" title="Topics 通配符模式"></a>Topics 通配符模式</h3><ul>
<li><p>Topic 类型与 Direct 相比，都是可以根据 RoutingKey 把消息路由到不同的队列。只不过 Topic 类型Exchange 可以让队列在绑定 Routing key 的时候使用通配符</p>
</li>
<li><p>Routingkey 一般都是有一个或多个单词组成，多个单词之间以”.”分割，例如： item.insert</p>
</li>
<li><p>通配符规则：<code>#</code> 匹配0个或多个单词，<code>*</code> 匹配1个单词，</p>
<p>例如：<code>item.#</code> 能够匹配 <code>item.insert.abc,</code> 或者 <code>item.insert</code>. </p>
<p><code>item.*</code> 只能匹配 <code>item.insert</code></p>
</li>
</ul>
<p><img src="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/48e93035a0b9b56a10c3a322efa5527a-565deff.png" alt="image-20220712110100820"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">红色 Queue：绑定的是 usa.# ，因此凡是以 usa. 开头的 routing key 都会被匹配到</span><br><span class="line">黄色 Queue：绑定的是 #.news ，因此凡是以 .news 结尾的 routing key 都会被匹配</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment"># emit_log_topic.php 生产者</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/vendor/autoload.php&#x27;</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Message</span>\<span class="title">AMQPMessage</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$connection</span> = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">5672</span>, <span class="string">&#x27;guest&#x27;</span>, <span class="string">&#x27;guest&#x27;</span>);</span><br><span class="line"><span class="variable">$channel</span> = <span class="variable">$connection</span>-&gt;channel();</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;exchange_declare(<span class="string">&#x27;topic_logs&#x27;</span>, <span class="string">&#x27;topic&#x27;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$routing_key</span> = <span class="keyword">isset</span>(<span class="variable">$argv</span>[<span class="number">1</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$argv</span>[<span class="number">1</span>]) ? <span class="variable">$argv</span>[<span class="number">1</span>] : <span class="string">&#x27;anonymous.info&#x27;</span>;</span><br><span class="line"><span class="variable">$data</span> = implode(<span class="string">&#x27; &#x27;</span>, array_slice(<span class="variable">$argv</span>, <span class="number">2</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">    <span class="variable">$data</span> = <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$msg</span> = <span class="keyword">new</span> AMQPMessage(<span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;basic_publish(<span class="variable">$msg</span>, <span class="string">&#x27;topic_logs&#x27;</span>, <span class="variable">$routing_key</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27; [x] Sent &#x27;</span>, <span class="variable">$routing_key</span>, <span class="string">&#x27;:&#x27;</span>, <span class="variable">$data</span>, <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;close();</span><br><span class="line"><span class="variable">$connection</span>-&gt;close();</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment"># receive_logs_topic.php 消费者</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/vendor/autoload.php&#x27;</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$connection</span> = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">5672</span>, <span class="string">&#x27;guest&#x27;</span>, <span class="string">&#x27;guest&#x27;</span>);</span><br><span class="line"><span class="variable">$channel</span> = <span class="variable">$connection</span>-&gt;channel();</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;exchange_declare(<span class="string">&#x27;topic_logs&#x27;</span>, <span class="string">&#x27;topic&#x27;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">list</span>(<span class="variable">$queue_name</span>, ,) = <span class="variable">$channel</span>-&gt;queue_declare(<span class="string">&quot;&quot;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$binding_keys</span> = array_slice(<span class="variable">$argv</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$binding_keys</span>)) &#123;</span><br><span class="line">    file_put_contents(<span class="string">&#x27;php://stderr&#x27;</span>, <span class="string">&quot;Usage: <span class="subst">$argv</span>[0] [binding_key]\n&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$binding_keys</span> <span class="keyword">as</span> <span class="variable">$binding_key</span>) &#123;</span><br><span class="line">    <span class="variable">$channel</span>-&gt;queue_bind(<span class="variable">$queue_name</span>, <span class="string">&#x27;topic_logs&#x27;</span>, <span class="variable">$binding_key</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot; [*] Waiting for logs. To exit press CTRL+C\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$callback</span> = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$msg</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27; [x] &#x27;</span>, <span class="variable">$msg</span>-&gt;delivery_info[<span class="string">&#x27;routing_key&#x27;</span>], <span class="string">&#x27;:&#x27;</span>, <span class="variable">$msg</span>-&gt;body, <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;basic_consume(<span class="variable">$queue_name</span>, <span class="string">&#x27;&#x27;</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="variable">$callback</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="variable">$channel</span>-&gt;is_open()) &#123;</span><br><span class="line">    <span class="variable">$channel</span>-&gt;wait();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$channel</span>-&gt;close();</span><br><span class="line"><span class="variable">$connection</span>-&gt;close();</span><br></pre></td></tr></table></figure>

<h3 id="工作模式总结"><a href="#工作模式总结" class="headerlink" title="工作模式总结"></a>工作模式总结</h3><ul>
<li><p><strong>简单模式</strong> HelloWorld</p>
<p>一个生产者、一个消费者，不需要设置交换机（使用默认的交换机）。</p>
</li>
<li><p><strong>工作队列模式</strong> Work Queue</p>
<p>一个生产者、多个消费者（竞争关系），不需要设置交换机（使用默认的交换机）。</p>
</li>
<li><p><strong>发布订阅模式</strong> Publish/subscribe</p>
<p>需要设置类型为 fanout 的交换机，并且交换机和队列进行绑定，当发送消息到交换机后，交换机会将消息发送到绑定的队列。</p>
</li>
<li><p><strong>路由模式</strong> Routing</p>
<p>需要设置类型为 direct 的交换机，交换机和队列进行绑定，并且指定 routing key，当发送消息到交换机后，交换机会根据 routing key 将消息发送到对应的队列。</p>
</li>
<li><p><strong>通配符模式</strong> Topic</p>
<p>需要设置类型为 topic 的交换机，交换机和队列进行绑定，并且指定通配符方式的routing key，当发送消息到交换机后，交换机会根据 routing key 将消息发送到对应的队列。</p>
</li>
</ul>
<h2 id="高级特性"><a href="#高级特性" class="headerlink" title="高级特性"></a>高级特性</h2><h3 id="消息可靠性投递"><a href="#消息可靠性投递" class="headerlink" title="消息可靠性投递"></a>消息可靠性投递</h3><p>在使用 RabbitMQ 的时候，作为<strong>消息发送方</strong>希望杜绝任何<strong>消息丢失</strong>或者<strong>投递失败</strong>场景。RabbitMQ 提供两种方式用来控制消息的投递可靠性模式。</p>
<ul>
<li><p><strong>confirm 确认模式</strong></p>
<p>此模式是作用在<strong>生产者</strong>的，开启了这个模式就可以知道消息有没有发送到 <strong>Exchange</strong>上。不管有没有发送到都会触发回调方法。</p>
<ul>
<li>消息成功投递到Exchange, 返回ack</li>
<li>消息未投递到Exchange, 返回nack</li>
</ul>
</li>
<li><p><strong>return 退回模式</strong></p>
<p>此模式同样是作用在<strong>生产者</strong>端的，这个模式就是为了知道消息有没有发送到对应的 <strong>Queue</strong>上。如果发送到了对应的队列不会触发回调方法，如果没有发送到对应的队列才会触发回调方法。</p>
<p>即消息投递到交换机了，但是没有路由到队列，返回ACK，及路由失败原因。</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq 整个消息投递的路径为：</span><br><span class="line">           producer---&gt;rabbitmq broker---&gt;exchange---&gt;queue---&gt;consumer</span><br><span class="line"> - 消息从 producer 到 exchange 则会返回一个 confirmCallback 。</span><br><span class="line"> - 消息从 exchange--&gt;queue 投递失败则会返回一个 returnCallback 。</span><br><span class="line">我们将利用这两个 callback 控制消息的可靠性投递</span><br></pre></td></tr></table></figure>

<h3 id="Consumer-ACK"><a href="#Consumer-ACK" class="headerlink" title="Consumer ACK"></a>Consumer ACK</h3><p><strong>Ack</strong> 指 <strong>Acknowledge</strong>确认。 表示消费端收到消息后的确认方式。有三种确认方式：</p>
<ul>
<li>自动确认：<code>acknowledge=&quot;none&quot;</code></li>
<li>手动确认：<code>acknowledge=&quot;manual&quot;</code></li>
<li>根据异常情况确认：<code>acknowledge=&quot;auto&quot;</code></li>
</ul>
<p>其中自动确认是指，当消息一旦被<strong>Consumer</strong>接收到，则自动确认收到 (<code>AMQP_AUTOACK</code>)，并将相应 <code>message</code> 从 RabbitMQ 的消息缓存中移除。</p>
<p>但是在实际业务处理中，很可能消息接收到，业务处理出现异常，那么该消息就会丢失。如果设置了<strong>手动确认</strong>方式，则需要在业务处理成功后，调用<code>ack()</code>，手动签收。</p>
<p>如果出现异常，则调用<code>nack()</code>方法，让其自动<strong>重新发送</strong>消息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">即要达到消息的可靠性, 需要以下方面配合:</span><br><span class="line"> - 持久化</span><br><span class="line">    • Exchange要持久化</span><br><span class="line">    • Queue要持久化</span><br><span class="line">    • message要持久化</span><br><span class="line"> - 生产方确认Confirm</span><br><span class="line"> - 消费方确认Ack</span><br><span class="line"> - Broker高可用</span><br></pre></td></tr></table></figure>

<h3 id="消费端限流"><a href="#消费端限流" class="headerlink" title="消费端限流"></a>消费端限流</h3><p>消息队列中囤积了大量的消息, 或者某些时刻生产的消息远远大于消费者处理能力的时候, 这个时候如果消费者一次取出大量的消息, 但是客户端又无法处理, 就会出现问题, 甚至可能导致服务崩溃, 所以需要对消费端进行限流</p>
<p>RabbitMQ提供了一种**qos(服务质量保证)**功能, 即在非自动确认消息的前提下, 如果一定数目的消息(通过consumer或者channel设置qos的值)未被确认前, 不进行消费新的消息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">消费端的确认模式一定为手动确认。acknowledge=&quot;manual&quot;</span><br><span class="line">channel.setPrefetchSize : 消息大小限制, 一般设置为0, 消费端不做限制</span><br><span class="line">channel.setPrefetchCount : 会告诉RabbitMQ不要同时给一个消费者推送多于N个消息, 即一旦有N个消息还没有ack, 则该consumer将block(阻塞), 直到有消息ack</span><br></pre></td></tr></table></figure>

<h3 id="TTL"><a href="#TTL" class="headerlink" title="TTL"></a>TTL</h3><p><strong>TTL</strong> 全称 <strong>Time To Live</strong>（<strong>存活时间/过期时间</strong>）。当消息到达存活时间后，还没有被消费，会被自动清除。<br>RabbitMQ 可以对<strong>消息</strong>设置过期时间，也可以对整个<strong>队列</strong>（Queue）设置过期时间。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">设置队列过期时间使用参数：x-message-ttl，单位：ms(毫秒)，会对整个队列消息统一过期。</span><br><span class="line"></span><br><span class="line">设置消息过期时间使用参数：expiration。单位：ms(毫秒)，当该消息在队列头部时（消费时），会单独判断这一消息是否过期。</span><br><span class="line"></span><br><span class="line">如果两者都进行了设置，以时间短的为准。</span><br></pre></td></tr></table></figure>

<h3 id="死信队列"><a href="#死信队列" class="headerlink" title="死信队列"></a>死信队列</h3><p>死信队列，英文缩写：<strong>DLX</strong> 。<strong>Dead Letter Exchange</strong>（<strong>死信交换机</strong>），当消息成为Dead message后，可以被重新发送到另一个交换机，这个交换机就是DLX。</p>
<p>如果这个包含死信的队列配置了<code>dead-letter-exchange</code>属性，指定了一个交换机，那么队列中的死信就会投递到这个交换机中，而这个交换机称为<strong>死信交换机</strong>（Dead Letter Exchange，检查DLX）</p>
<p><img src="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/8400f6d6dca3bfa82e81db7608ab2441-385bb10.png" alt="image-20220712135131320"></p>
<p>消息成为死信的三种情况：</p>
<ol>
<li>队列消息长度到达限制；</li>
<li>消费者拒接消费消息，Nack/Reject,并且不把消息重新放入原目标队列,requeue=false；</li>
<li>原队列存在消息过期设置，消息到达超时时间未被消费</li>
</ol>
<h3 id="延迟队列"><a href="#延迟队列" class="headerlink" title="延迟队列"></a>延迟队列</h3><p>延迟队列，即消息进入队列后不会立即被消费，只有到达指定时间后，才会被消费。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">如需求：</span><br><span class="line"> - 下单后，30分钟未支付，取消订单，回滚库存。</span><br><span class="line"> - 新用户注册成功7天后，发送短信问候。</span><br></pre></td></tr></table></figure>

<p>可以使用 <strong>TTL+死信队列</strong> 组合<strong>实现延迟队列</strong>的效果。</p>
<p><img src="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/a28075f703394aab53246a0bc4d51633-d0d7ea0.png" alt="image-20220712135435128"></p>
<p>也可以通过使用<strong>DelayExchange</strong>插件实现</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins enable rabbitmq_delayed_message_exchange</span><br><span class="line"><span class="meta">#</span><span class="bash"> 文档: https://github.com/rabbitmq/rabbitmq-delayed-message-exchange</span></span><br></pre></td></tr></table></figure>

<p>DelayExchange插件对官方原生的Exchange做了功能升级:</p>
<ul>
<li>将DelayExchange中接收到的消息暂存在内存中</li>
<li>在DelayExchange中计时, 超时后才投递消息到队列</li>
</ul>
<p>管理平台声明一个DelayExchange: </p>
<p><img src="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/abf47e01b132a72b26cf044923bd478e-95f15e9.png" alt="image-20220712185348243"></p>
<h3 id="日志与监控"><a href="#日志与监控" class="headerlink" title="日志与监控"></a>日志与监控</h3><p>RabbitMQ默认日志存放路径： <code>/var/log/rabbitmq/rabbit@xxx.log</code></p>
<p>日志包含了RabbitMQ的版本号、Erlang的版本号、RabbitMQ服务节点名称、cookie的hash值、RabbitMQ配置文件地址、内存限制、磁盘限制、默认账户guest的创建以及权限配置等等。</p>
<p>也可以通过web控制台/命令行监控</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 查看队列</span><br><span class="line">rabbitmqctl list_queues</span><br><span class="line"></span><br><span class="line"># 查看exchanges</span><br><span class="line">rabbitmqctl list_exchanges</span><br><span class="line"></span><br><span class="line"># 查看用户</span><br><span class="line">rabbitmqctl list_users</span><br><span class="line"></span><br><span class="line"># 查看连接</span><br><span class="line">rabbitmqctl list_connections</span><br><span class="line"></span><br><span class="line"># 查看消费者信息</span><br><span class="line">rabbitmqctl list_consumers</span><br><span class="line"></span><br><span class="line"># 查看环境变量</span><br><span class="line">rabbitmqctl environment</span><br><span class="line"></span><br><span class="line"># 查看未被确认的队列</span><br><span class="line">rabbitmqctl list_queues name messages_unacknowledged</span><br><span class="line"></span><br><span class="line"># 查看单个队列的内存使用</span><br><span class="line">rabbitmqctl list_queues name memory</span><br><span class="line"></span><br><span class="line"># 查看准备就绪的队列</span><br><span class="line">rabbitmqctl list_queues name messages_ready</span><br></pre></td></tr></table></figure>

<h3 id="消息追踪"><a href="#消息追踪" class="headerlink" title="消息追踪"></a>消息追踪</h3><p>在使用任何消息中间件的过程中，难免会出现某条<strong>消息异常丢失</strong>的情况。</p>
<p>对于RabbitMQ而言，可能是因为生产者或消费者与RabbitMQ断开了连接，而它们与RabbitMQ又采用了不同的确认机制；也有可能是因为交换器与队列之间不同的转发策略；甚至是交换器并没有与任何队列进行绑定，生产者又不感知或者没有采取相应的措施；另外RabbitMQ本身的集群策略也可能导致消息的丢失。这个时候就需要有一个较好的机制<strong>跟踪记录消息的投递过程</strong>，以此协助开发和运维人员进行问题的定位。</p>
<p>在RabbitMQ中可以使用 <strong>Firehose</strong> 和 <strong>rabbitmq_tracing插件</strong> 功能来实现消息追踪。</p>
<ul>
<li><p><strong>Firehose</strong></p>
<p>firehose的机制是将生产者投递给rabbitmq的消息，rabbitmq投递给消费者的消息 按照指定的格式发送到<strong>默认的exchange</strong>上。</p>
<p>这个默认的exchange的名称为<code>amq.rabbitmq.trace</code>，它是一个<strong>topic类型</strong>的exchange。</p>
<p>发送到这个exchange上的消息的<code>routing key</code>为 <code>publish.exchangename</code> 和<code>deliver.queuename</code>。其中<code>exchangename</code>和<code>queuename</code>为实际exchange和queue的名称，分别对应<strong>生产者投递到exchange的消息</strong>，和<strong>消费者从queue上获取的消息</strong> </p>
<p><img src="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/aee3f04b21ad52736bc5a03b3e6129ed-dbd411f.png" alt="image-20220712140547006"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl trace_on：开启Firehose命令</span><br><span class="line">rabbitmqctl trace_off：关闭Firehose命令</span><br><span class="line">注意：打开 trace 会影响消息写入功能，适当打开后请关闭。</span><br></pre></td></tr></table></figure></li>
<li><p><strong>rabbitmq_tracing</strong></p>
<p>rabbitmq_tracing和Firehose在实现上如出一辙，只不过rabbitmq_tracing的方式比Firehose多了一<br>层GUI的包装，更容易使用和管理。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">启用插件：rabbitmq-plugins enable rabbitmq_tracing</span><br></pre></td></tr></table></figure>

<p><img src="https://ni9ne.oss-cn-shanghai.aliyuncs.com/mdimg/1033b16f0ebc170558225fb6407130c7-9444cf8.png" alt="image-20220712141212675"></p>
</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>NI9NE
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://ni9ne.github.io/2022/04/14/MQ/RabbitMQ/RabbitMQ%E9%98%9F%E5%88%97%E4%BD%BF%E7%94%A8%E8%A7%A3%E6%9E%90/" title="RabbitMQ队列使用解析">https://ni9ne.github.io/2022/04/14/MQ/RabbitMQ/RabbitMQ队列使用解析/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/RabbitMQ/" rel="tag"># RabbitMQ</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/03/21/Python/Python01%E5%9F%BA%E7%A1%80/" rel="prev" title="Python01基础">
                  <i class="fa fa-chevron-left"></i> Python01基础
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/04/14/MQ/RabbitMQ/RabbitMQ%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98%E5%8F%8A%E9%AB%98%E5%8F%AF%E7%94%A8%E6%96%B9%E6%A1%88/" rel="next" title="RabbitMQ使用问题及高可用方案">
                  RabbitMQ使用问题及高可用方案 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2017 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">NI9NE</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@next-theme/pjax@0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  
<script src="https://unpkg.com/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>


  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
